<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduTrack - Advanced Assignment Tracker</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .tab-active { border-bottom: 2px solid #3b82f6; color: #3b82f6; }
        .tab-inactive { color: #6b7280; }
        .grade-A { color: #10b981; }
        .grade-B { color: #3b82f6; }
        .grade-C { color: #f59e0b; }
        .grade-D { color: #f97316; }
        .grade-F { color: #ef4444; }
        
        /* Modal Transitions */
        .modal { transition: opacity 0.25s ease; }
        body.modal-active { overflow-x: hidden; overflow-y: hidden !important; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <!-- Navbar -->
    <nav class="bg-white shadow-sm p-4">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold text-gray-800"><i class="fa-solid fa-graduation-cap text-blue-600"></i> EduTrack</h1>
            <div class="flex items-center gap-4">
                <div id="gpa-display" class="font-bold text-gray-700 bg-gray-100 px-3 py-1 rounded">GPA: 0.00</div>
                <button id="login-btn" onclick="signIn()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition">
                    <i class="fa-brands fa-google"></i> Login
                </button>
                <div id="user-profile" class="hidden flex items-center gap-2">
                    <span id="user-email" class="text-sm text-gray-600"></span>
                    <button onclick="saveToCloud()" class="bg-green-600 text-white px-3 py-1 text-sm rounded hover:bg-green-700">
                        <i class="fa-solid fa-cloud-arrow-up"></i> Save
                    </button>
                    <button onclick="signOut()" class="text-red-500 text-sm hover:underline">Logout</button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto p-4 mt-6">
        
        <!-- Controls -->
        <div class="mb-6 flex justify-between items-center">
            <button onclick="openModal('class-modal')" class="bg-indigo-600 text-white px-4 py-2 rounded shadow hover:bg-indigo-700 transition">
                <i class="fa-solid fa-plus"></i> Add Class
            </button>
        </div>

        <!-- Class Tabs -->
        <div class="flex overflow-x-auto border-b border-gray-200 bg-white rounded-t-lg px-2" id="tabs-container">
            <!-- Tabs injected by JS -->
        </div>

        <!-- Tab Content Area -->
        <div class="bg-white rounded-b-lg shadow-md p-6 min-h-[500px]" id="tab-content">
            <div class="text-center text-gray-400 mt-20">
                <i class="fa-regular fa-folder-open text-6xl mb-4"></i>
                <p>Select a class tab or add a new class to get started.</p>
            </div>
        </div>
    </div>

    <!-- MODALS -->

    <!-- Add Class Modal -->
    <div id="class-modal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50"></div>
        <div class="modal-container bg-white w-11/12 md:max-w-md mx-auto rounded shadow-lg z-50 overflow-y-auto">
            <div class="modal-content py-4 text-left px-6">
                <div class="flex justify-between items-center pb-3">
                    <p class="text-2xl font-bold">Add New Class</p>
                    <div class="modal-close cursor-pointer z-50" onclick="closeModal('class-modal')">
                        <i class="fa-solid fa-times"></i>
                    </div>
                </div>
                <div class="my-5">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Class Name</label>
                    <input type="text" id="new-class-name" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="e.g. AP Calculus">
                </div>
                <div class="flex justify-end pt-2">
                    <button onclick="addClass()" class="px-4 bg-blue-600 p-3 rounded-lg text-white hover:bg-blue-700">Create</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Class / Categories Modal -->
    <div id="settings-modal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50"></div>
        <div class="modal-container bg-white w-11/12 md:max-w-lg mx-auto rounded shadow-lg z-50 overflow-y-auto">
            <div class="modal-content py-4 text-left px-6">
                <div class="flex justify-between items-center pb-3">
                    <p class="text-2xl font-bold">Class Settings</p>
                    <div class="modal-close cursor-pointer" onclick="closeModal('settings-modal')">
                        <i class="fa-solid fa-times"></i>
                    </div>
                </div>
                
                <h3 class="font-bold text-gray-700 mb-2">Weighted Categories</h3>
                <p class="text-xs text-gray-500 mb-4">Weights should add up to 100%.</p>
                
                <div id="categories-list" class="space-y-2 mb-4">
                    <!-- Categories injected here -->
                </div>

                <div class="flex gap-2 mb-4">
                    <input type="text" id="new-cat-name" placeholder="Category Name" class="border rounded p-2 flex-grow text-sm">
                    <input type="number" id="new-cat-weight" placeholder="%" class="border rounded p-2 w-20 text-sm">
                    <button onclick="addCategory()" class="bg-green-500 text-white px-3 rounded hover:bg-green-600"><i class="fa-solid fa-plus"></i></button>
                </div>

                <div class="border-t pt-4 mt-4 flex justify-between">
                    <button onclick="deleteClass()" class="text-red-600 hover:text-red-800 text-sm font-bold">Delete Class</button>
                    <button onclick="closeModal('settings-modal')" class="bg-gray-300 text-gray-800 px-4 py-2 rounded">Done</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Assignment Modal -->
    <div id="assignment-modal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50"></div>
        <div class="modal-container bg-white w-11/12 md:max-w-md mx-auto rounded shadow-lg z-50 overflow-y-auto">
            <div class="modal-content py-4 text-left px-6">
                <div class="flex justify-between items-center pb-3">
                    <p class="text-2xl font-bold">Add Assignment</p>
                    <div class="modal-close cursor-pointer" onclick="closeModal('assignment-modal')">
                        <i class="fa-solid fa-times"></i>
                    </div>
                </div>
                <div class="space-y-4">
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Name</label>
                        <input type="text" id="assign-name" class="shadow border rounded w-full py-2 px-3">
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Category</label>
                        <select id="assign-category" class="shadow border rounded w-full py-2 px-3 bg-white"></select>
                    </div>
                    <div class="flex gap-4">
                        <div class="w-1/2">
                            <label class="block text-gray-700 text-sm font-bold mb-2">Score</label>
                            <input type="number" id="assign-score" class="shadow border rounded w-full py-2 px-3">
                        </div>
                        <div class="w-1/2">
                            <label class="block text-gray-700 text-sm font-bold mb-2">Total Points</label>
                            <input type="number" id="assign-total" value="100" class="shadow border rounded w-full py-2 px-3">
                        </div>
                    </div>
                </div>
                <div class="flex justify-end pt-6">
                    <button onclick="saveAssignment()" class="px-4 bg-blue-600 py-2 rounded text-white hover:bg-blue-700">Save Assignment</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Configuration ---
        const SUPABASE_URL = 'https://njgjgpiamweujgyknqtz.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_3bRvo_Zuppdi4ICnOtfjeA_VWfp6Zyx'; 
        
        // --- State Management ---
        let classes = [];
        let activeClassId = null;
        let user = null;
        
        // Initialize Supabase
        // Note: The key provided in prompt was 'sb_publishable...', usually keys are 'eyJ...'. 
        // Assuming the user provided a valid key format, if not, this part will fail silently in console.
        // I will use the exact string provided.
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- Initialization ---
        window.onload = async function() {
            // Load from local storage first for speed
            const localData = localStorage.getItem('edutrack_data');
            if (localData) {
                classes = JSON.parse(localData);
                renderTabs();
                updateGPA();
            }

            // Check Supabase Auth
            const { data: { session } } = await supabase.auth.getSession();
            if (session) {
                handleUserLogin(session.user);
            }
            
            // Listen for auth changes
            supabase.auth.onAuthStateChange((_event, session) => {
                if (session) handleUserLogin(session.user);
                else handleUserLogout();
            });
        };

        // --- Auth Functions ---
        async function signIn() {
            await supabase.auth.signInWithOAuth({
                provider: 'google',
                options: {
                    redirectTo: 'https://njgjgpiamweujgyknqtz.supabase.co/auth/v1/callback'
                }
            });
        }

        async function signOut() {
            await supabase.auth.signOut();
            classes = []; // Clear data on logout
            localStorage.removeItem('edutrack_data');
            renderTabs();
            document.getElementById('tab-content').innerHTML = '';
        }

        async function handleUserLogin(userData) {
            user = userData;
            document.getElementById('login-btn').classList.add('hidden');
            document.getElementById('user-profile').classList.remove('hidden');
            document.getElementById('user-email').innerText = user.email;
            
            // Fetch data from Supabase
            await loadFromCloud();
        }

        function handleUserLogout() {
            user = null;
            document.getElementById('login-btn').classList.remove('hidden');
            document.getElementById('user-profile').classList.add('hidden');
        }

        // --- Data Persistence ---
        function saveData() {
            // Save locally
            localStorage.setItem('edutrack_data', JSON.stringify(classes));
            renderTabs();
            if(activeClassId) renderClassContent(activeClassId);
            updateGPA();
        }

        async function saveToCloud() {
            if (!user) return alert("Please login to save to cloud.");
            
            const { error } = await supabase
                .from('user_data')
                .upsert({ id: user.id, data: classes, updated_at: new Date() });

            if (error) {
                console.error('Error saving:', error);
                alert('Error saving to cloud');
            } else {
                alert('Data saved to cloud!');
            }
        }

        async function loadFromCloud() {
            if (!user) return;
            
            const { data, error } = await supabase
                .from('user_data')
                .select('data')
                .eq('id', user.id)
                .single();

            if (data && data.data) {
                // Merge or replace logic. Here we replace for simplicity.
                classes = data.data;
                saveData(); // Sync to local
            }
        }

        // --- Core Logic ---

        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        function addClass() {
            const name = document.getElementById('new-class-name').value;
            if (!name) return;

            const newClass = {
                id: generateId(),
                name: name,
                categories: [
                    { id: generateId(), name: 'Homework', weight: 40 },
                    { id: generateId(), name: 'Exams', weight: 60 }
                ],
                assignments: []
            };

            classes.push(newClass);
            document.getElementById('new-class-name').value = '';
            closeModal('class-modal');
            
            activeClassId = newClass.id;
            saveData();
        }

        function renderTabs() {
            const container = document.getElementById('tabs-container');
            container.innerHTML = '';

            classes.forEach(c => {
                const isActive = c.id === activeClassId;
                const tab = document.createElement('div');
                tab.className = `cursor-pointer px-6 py-3 font-medium text-sm whitespace-nowrap transition-colors ${isActive ? 'tab-active bg-blue-50' : 'tab-inactive hover:bg-gray-50'}`;
                tab.innerText = c.name;
                tab.onclick = () => {
                    activeClassId = c.id;
                    saveData(); // Just to trigger rerender
                };
                container.appendChild(tab);
            });
        }

        function getGradeLetter(percentage) {
            if (percentage >= 90) return 'A';
            if (percentage >= 80) return 'B';
            if (percentage >= 70) return 'C';
            if (percentage >= 60) return 'D';
            return 'F';
        }

        function calculateClassGrade(classObj) {
            let totalWeightedScore = 0;
            let totalWeightUsed = 0;

            classObj.categories.forEach(cat => {
                const catAssignments = classObj.assignments.filter(a => a.categoryId === cat.id);
                if (catAssignments.length > 0) {
                    let catPoints = 0;
                    let catTotal = 0;
                    catAssignments.forEach(a => {
                        catPoints += parseFloat(a.score);
                        catTotal += parseFloat(a.total);
                    });
                    
                    if (catTotal > 0) {
                        const catPercentage = catPoints / catTotal;
                        totalWeightedScore += (catPercentage * cat.weight);
                        totalWeightUsed += cat.weight;
                    }
                }
            });

            if (totalWeightUsed === 0) return 100; // Default if no work
            // Normalize to 100% based on used weight (so 50% homework filled still calculates out of 100% effectively if no exams yet)
            // Or simpler: Grade = TotalWeighted / (TotalWeightUsed/100)
            return (totalWeightedScore / totalWeightUsed) * 100;
        }

        function renderClassContent(classId) {
            const cls = classes.find(c => c.id === classId);
            if (!cls) return;

            const currentGrade = calculateClassGrade(cls);
            const letter = getGradeLetter(currentGrade);
            const gradeColor = `grade-${letter}`;

            const container = document.getElementById('tab-content');
            container.innerHTML = `
                <div class="flex justify-between items-start mb-8">
                    <div>
                        <h2 class="text-3xl font-bold text-gray-800">${cls.name}</h2>
                        <div class="text-5xl font-bold mt-2 ${gradeColor}">${currentGrade.toFixed(2)}% <span class="text-2xl text-gray-400">${letter}</span></div>
                    </div>
                    <div class="flex gap-2">
                         <button onclick="openSettings('${cls.id}')" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded">
                            <i class="fa-solid fa-gear"></i> Settings
                        </button>
                        <button onclick="openAssignmentModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded shadow">
                            <i class="fa-solid fa-plus"></i> Assignment
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    ${cls.categories.map(cat => {
                        const catAssigns = cls.assignments.filter(a => a.categoryId === cat.id);
                        return `
                        <div class="bg-gray-50 border rounded-lg p-4 shadow-sm">
                            <div class="flex justify-between items-center mb-3 border-b pb-2">
                                <h3 class="font-bold text-gray-700">${cat.name}</h3>
                                <span class="text-xs bg-gray-200 px-2 py-1 rounded text-gray-600">${cat.weight}%</span>
                            </div>
                            <div class="space-y-3">
                                ${catAssigns.length === 0 ? '<p class="text-sm text-gray-400 italic">No assignments</p>' : ''}
                                ${catAssigns.map(a => `
                                    <div class="flex justify-between items-center bg-white p-2 rounded border">
                                        <div class="truncate pr-2">
                                            <div class="text-sm font-medium">${a.name}</div>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <span class="text-sm font-bold ${getGradeColor(a.score/a.total*100)}">${a.score}/${a.total}</span>
                                            <button onclick="deleteAssignment('${a.id}')" class="text-red-400 hover:text-red-600"><i class="fa-solid fa-trash text-xs"></i></button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function getGradeColor(percent) {
            if(percent >= 90) return 'text-green-600';
            if(percent >= 80) return 'text-blue-600';
            if(percent >= 70) return 'text-yellow-600';
            if(percent >= 60) return 'text-orange-600';
            return 'text-red-600';
        }

        function updateGPA() {
            if (classes.length === 0) {
                document.getElementById('gpa-display').innerText = "GPA: 0.00";
                return;
            }

            let totalPoints = 0;
            classes.forEach(c => {
                const grade = calculateClassGrade(c);
                if (grade >= 90) totalPoints += 4.0;
                else if (grade >= 80) totalPoints += 3.0;
                else if (grade >= 70) totalPoints += 2.0;
                else if (grade >= 60) totalPoints += 1.0;
                else totalPoints += 0.0;
            });

            const gpa = totalPoints / classes.length;
            document.getElementById('gpa-display').innerText = `GPA: ${gpa.toFixed(2)}`;
        }

        // --- Settings / Categories Logic ---

        function openSettings(classId) {
            const cls = classes.find(c => c.id === classId);
            renderCategoriesList(cls);
            openModal('settings-modal');
        }

        function renderCategoriesList(cls) {
            const list = document.getElementById('categories-list');
            list.innerHTML = cls.categories.map(cat => `
                <div class="flex justify-between items-center bg-gray-100 p-2 rounded">
                    <span>${cat.name} (${cat.weight}%)</span>
                    <button onclick="removeCategory('${cls.id}', '${cat.id}')" class="text-red-500"><i class="fa-solid fa-times"></i></button>
                </div>
            `).join('');
        }

        function addCategory() {
            const cls = classes.find(c => c.id === activeClassId);
            const name = document.getElementById('new-cat-name').value;
            const weight = parseFloat(document.getElementById('new-cat-weight').value);
            
            if (name && weight) {
                cls.categories.push({ id: generateId(), name, weight });
                document.getElementById('new-cat-name').value = '';
                document.getElementById('new-cat-weight').value = '';
                renderCategoriesList(cls);
                saveData();
            }
        }

        function removeCategory(classId, catId) {
            const cls = classes.find(c => c.id === classId);
            cls.categories = cls.categories.filter(c => c.id !== catId);
            // Also remove assignments in this category to prevent orphans
            cls.assignments = cls.assignments.filter(a => a.categoryId !== catId);
            renderCategoriesList(cls);
            saveData();
        }

        function deleteClass() {
            if(confirm("Are you sure you want to delete this class?")) {
                classes = classes.filter(c => c.id !== activeClassId);
                activeClassId = classes.length > 0 ? classes[0].id : null;
                saveData();
                closeModal('settings-modal');
            }
        }

        // --- Assignment Logic ---

        function openAssignmentModal() {
            const cls = classes.find(c => c.id === activeClassId);
            const select = document.getElementById('assign-category');
            select.innerHTML = cls.categories.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            
            document.getElementById('assign-name').value = '';
            document.getElementById('assign-score').value = '';
            document.getElementById('assign-total').value = '100';
            
            openModal('assignment-modal');
        }

        function saveAssignment() {
            const cls = classes.find(c => c.id === activeClassId);
            const name = document.getElementById('assign-name').value;
            const catId = document.getElementById('assign-category').value;
            const score = document.getElementById('assign-score').value;
            const total = document.getElementById('assign-total').value;

            if (name && catId && score && total) {
                cls.assignments.push({
                    id: generateId(),
                    categoryId: catId,
                    name,
                    score: parseFloat(score),
                    total: parseFloat(total)
                });
                closeModal('assignment-modal');
                saveData();
            }
        }

        function deleteAssignment(assignId) {
            const cls = classes.find(c => c.id === activeClassId);
            cls.assignments = cls.assignments.filter(a => a.id !== assignId);
            saveData();
        }

        // --- Modal Utilities ---

        function openModal(modalID) {
            const modal = document.getElementById(modalID);
            modal.classList.remove('opacity-0', 'pointer-events-none');
            document.body.classList.add('modal-active');
        }

        function closeModal(modalID) {
            const modal = document.getElementById(modalID);
            modal.classList.add('opacity-0', 'pointer-events-none');
            document.body.classList.remove('modal-active');
        }
    </script>
</body>
</html>