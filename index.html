<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduTrack Pro - Cloud Sync</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .glass-card { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(8px); border: 1px solid rgba(226, 232, 240, 0.8); }
        #auth-overlay { background: #0f172a; display: flex; align-items: center; justify-content: center; position: fixed; inset: 0; z-index: 100; }
    </style>
</head>
<body class="bg-[#f0f2f5] text-slate-900 min-h-screen">

    <!-- Auth Overlay -->
    <div id="auth-overlay">
        <div class="bg-white w-full max-w-md rounded-[2.5rem] p-10 shadow-2xl mx-4">
            <div class="text-center mb-8">
                <div class="bg-indigo-600 w-16 h-16 rounded-2xl flex items-center justify-center text-white mx-auto mb-4">
                    <svg width="32" height="32" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M22 10v6M2 10l10-5 10 5-10 5z"/><path d="M6 12v5c3 3 9 3 12 0v-5"/></svg>
                </div>
                <h2 class="text-3xl font-extrabold">EduTrack Cloud</h2>
                <p class="text-slate-500 mt-2">Sign in to sync your data</p>
            </div>
            <div class="space-y-4">
                <input id="auth-email" type="email" placeholder="Email Address" class="w-full px-6 py-4 rounded-2xl bg-slate-50 border border-slate-100 outline-none focus:ring-2 ring-indigo-500/20 font-medium">
                <input id="auth-password" type="password" placeholder="Password" class="w-full px-6 py-4 rounded-2xl bg-slate-50 border border-slate-100 outline-none focus:ring-2 ring-indigo-500/20 font-medium">
                <button id="btn-login" class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-bold text-lg hover:bg-indigo-700 transition-all">Sign In / Sign Up</button>
                <div id="auth-error" class="text-red-500 text-sm font-bold text-center hidden"></div>
                <div id="auth-status" class="text-slate-400 text-xs text-center">New users will be registered automatically.</div>
            </div>
        </div>
    </div>

    <!-- App UI -->
    <div id="app-container" class="hidden flex flex-col md:flex-row min-h-screen">
        <aside class="w-full md:w-80 bg-white border-r border-slate-200 flex flex-col p-6 sticky top-0 h-auto md:h-screen">
            <div class="flex items-center justify-between mb-10 px-2">
                <div class="flex items-center gap-3">
                    <div class="bg-indigo-600 p-2 rounded-xl text-white">
                        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="3"><path d="M22 10v6M2 10l10-5 10 5-10 5z"/><path d="M6 12v5c3 3 9 3 12 0v-5"/></svg>
                    </div>
                    <h1 class="font-extrabold text-xl">EduTrack</h1>
                </div>
                <div id="sync-dot" class="w-3 h-3 rounded-full bg-emerald-500 shadow-sm"></div>
            </div>
            
            <nav class="space-y-2 flex-1">
                <button onclick="switchTab('dashboard')" class="w-full text-left px-5 py-4 rounded-2xl font-bold text-slate-600 hover:bg-slate-50">Dashboard</button>
                <button onclick="switchTab('semester')" class="w-full text-left px-5 py-4 rounded-2xl font-bold text-slate-600 hover:bg-slate-50">Semesters</button>
            </nav>

            <div class="pt-6 border-t mt-auto">
                <p id="user-email" class="text-[10px] font-black text-slate-400 uppercase mb-4 truncate"></p>
                <button onclick="handleLogout()" class="w-full bg-slate-100 text-slate-600 py-3 rounded-2xl font-bold text-sm hover:bg-red-50 hover:text-red-600 transition-all">Logout</button>
            </div>
        </aside>

        <main class="flex-1 p-8 md:p-12 overflow-y-auto">
            <div id="tab-dashboard" class="tab-content active space-y-8">
                <h2 class="text-4xl font-extrabold">Welcome back!</h2>
                <div id="dash-grid" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
            </div>
            <div id="tab-semester" class="tab-content space-y-8">
                <div class="flex justify-between items-center">
                    <h2 class="text-3xl font-extrabold">Manage Semesters</h2>
                    <button onclick="addSemester()" class="bg-indigo-600 text-white px-6 py-3 rounded-2xl font-bold">+ New</button>
                </div>
                <div id="sem-list" class="space-y-6"></div>
            </div>
        </main>
    </div>

    <script>
        const SB_URL = 'https://njgjgpiamweujgyknqtz.supabase.co';
        const SB_KEY = 'sb_publishable_3bRvo_Zuppdi4ICnOtfjeA_VWfp6Zyx';
        const supabase = window.supabase.createClient(SB_URL, SB_KEY);

        let currentUser = null;
        let state = { semesters: [] };

        async function init() {
            // Check session on load
            const { data: { session } } = await supabase.auth.getSession();
            if (session) {
                setupUser(session.user);
            }

            // Listen for auth changes
            supabase.auth.onAuthStateChange((event, session) => {
                if (event === 'SIGNED_IN' || event === 'USER_UPDATED') {
                    setupUser(session.user);
                } else if (event === 'SIGNED_OUT') {
                    window.location.reload();
                }
            });
        }

        async function setupUser(user) {
            currentUser = user;
            document.getElementById('auth-overlay').style.display = 'none';
            document.getElementById('app-container').classList.remove('hidden');
            document.getElementById('user-email').innerText = user.email;
            await loadData();
        }

        document.getElementById('btn-login').addEventListener('click', async () => {
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            const btn = document.getElementById('btn-login');
            const errorDiv = document.getElementById('auth-error');

            if (!email || !password) return;

            btn.disabled = true;
            btn.innerText = "Processing...";
            errorDiv.classList.add('hidden');

            // 1. Try Login
            const { data: inData, error: inError } = await supabase.auth.signInWithPassword({ email, password });
            
            if (inError) {
                // 2. Try Signup if login fails (standard "Auto-join" flow)
                const { data: upData, error: upError } = await supabase.auth.signUp({ email, password });
                
                if (upError) {
                    errorDiv.innerText = upError.message;
                    errorDiv.classList.remove('hidden');
                    btn.disabled = false;
                    btn.innerText = "Sign In / Sign Up";
                } else {
                    // Check if they need to verify email
                    if (upData.user && upData.session === null) {
                        document.getElementById('auth-status').innerText = "Account created! Please check your email to verify.";
                        document.getElementById('auth-status').classList.replace('text-slate-400', 'text-emerald-500');
                        btn.innerText = "Check Email";
                    }
                }
            }
        });

        async function loadData() {
            const { data, error } = await supabase
                .from('user_data')
                .select('payload')
                .eq('id', currentUser.id)
                .maybeSingle();

            if (data?.payload) {
                state = data.payload;
            } else {
                state = { semesters: [{ id: Date.now(), name: 'Fall 2024', courses: [] }] };
            }
            render();
        }

        async function sync() {
            if (!currentUser) return;
            document.getElementById('sync-dot').classList.replace('bg-emerald-500', 'bg-amber-500');
            
            await supabase
                .from('user_data')
                .upsert({ id: currentUser.id, payload: state, updated_at: new Date() });

            setTimeout(() => {
                document.getElementById('sync-dot').classList.replace('bg-amber-500', 'bg-emerald-500');
            }, 500);
            render();
        }

        function render() {
            // Dashboard
            const dash = document.getElementById('dash-grid');
            dash.innerHTML = state.semesters.map(s => `
                <div class="glass-card p-6 rounded-3xl">
                    <h3 class="font-bold text-lg">${s.name}</h3>
                    <p class="text-sm text-slate-400">${s.courses.length} Courses</p>
                </div>
            `).join('');

            // Semester List
            const list = document.getElementById('sem-list');
            list.innerHTML = state.semesters.map(s => `
                <div class="bg-white p-6 rounded-3xl border border-slate-100 shadow-sm flex items-center justify-between">
                    <input class="font-bold text-xl outline-none" value="${s.name}" onchange="updateSem('${s.id}', this.value)">
                    <button onclick="deleteSem('${s.id}')" class="text-slate-300 hover:text-red-500">Delete</button>
                </div>
            `).join('');
        }

        window.updateSem = (id, val) => {
            state.semesters.find(s => s.id == id).name = val;
            sync();
        };

        window.addSemester = () => {
            state.semesters.push({ id: Date.now(), name: 'New Semester', courses: [] });
            sync();
        };

        window.deleteSem = (id) => {
            state.semesters = state.semesters.filter(s => s.id != id);
            sync();
        };

        window.handleLogout = () => supabase.auth.signOut();

        window.switchTab = (id) => {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById('tab-'+id).classList.add('active');
        };

        init();
    </script>
</body>
</html>

