<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduTrack - Smart Assignment Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Library for PDF Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <!-- Quill.js for Rich Text Editing -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: {
                            bg: '#111827',
                            card: '#1f2937',
                            text: '#f3f4f6',
                            muted: '#9ca3af',
                            border: '#374151'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s, color 0.3s;
        }

        /* Light Mode Defaults */
        body {
            background-color: #f3f4f6;
            color: #1f2937;
        }

        .card {
            background-color: #ffffff;
        }

        .tab-active {
            border-bottom: 2px solid #2563eb;
            color: #2563eb;
            font-weight: 600;
        }

        .tab-inactive {
            color: #6b7280;
            border-bottom: 2px solid transparent;
        }

        /* Dark Mode Overrides */
        .dark body {
            background-color: #111827;
            color: #f3f4f6;
        }

        .dark .card {
            background-color: #1f2937;
            border-color: #374151;
        }

        .dark .tab-inactive {
            color: #9ca3af;
        }

        .dark nav {
            background-color: #1f2937;
            border-color: #374151;
        }

        .dark input,
        .dark select,
        .dark textarea {
            background-color: #374151;
            color: white;
            border-color: #4b5563;
        }

        .dark .modal-container {
            background-color: #1f2937;
            color: white;
        }

        .modal {
            transition: opacity 0.25s ease;
        }

        body.modal-active {
            overflow: hidden;
        }

        /* Status Badges */
        .status-not-started {
            background-color: #f3f4f6;
            color: #374151;
        }

        .status-in-progress {
            background-color: #e0f2fe;
            color: #0284c7;
        }

        .status-completed {
            background-color: #dcfce7;
            color: #16a34a;
        }

        .status-submitted {
            background-color: #e0e7ff;
            color: #4338ca;
        }

        .status-na {
            background-color: #f9fafb;
            color: #9ca3af;
            text-decoration: line-through;
        }

        /* Calendar Styles */
        .calendar-day {
            min-height: 100px;
            transition: background-color 0.2s;
        }

        .calendar-day:hover {
            background-color: #f9fafb;
        }

        .calendar-event {
            font-size: 0.75rem;
            padding: 2px 4px;
            margin-bottom: 2px;
            border-radius: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            cursor: pointer;
        }

        /* Dark Mode Calendar */
        .dark .calendar-day {
            background-color: #1f2937;
            border-color: #374151;
        }

        .dark .calendar-day:hover {
            background-color: #374151;
        }

        .dark .calendar-header {
            background-color: #374151;
            color: #d1d5db;
        }

        .dark .calendar-grid-bg {
            background-color: #374151;
            border-color: #374151;
        }

        /* QUILL EDITOR OVERRIDES */
        .dark .ql-toolbar {
            background-color: #374151;
            border-color: #4b5563;
        }

        .dark .ql-container {
            background-color: #1f2937;
            border-color: #4b5563;
            color: #f3f4f6;
        }

        .dark .ql-stroke {
            stroke: #d1d5db !important;
        }

        .dark .ql-fill {
            fill: #d1d5db !important;
        }

        .dark .ql-picker {
            color: #d1d5db;
        }

        .dark .ql-picker-options {
            background-color: #374151;
            border-color: #4b5563;
        }

        #editor-container {
            height: 400px;
        }

        /* Fix for Quill font size dropdown width */
        .ql-snow .ql-picker.ql-size {
            width: 60px;
        }
    </style>
</head>

<body class="text-gray-800">

    <!-- Navbar -->
    <nav class="bg-white shadow-sm p-4 sticky top-0 z-30 dark:bg-gray-800 dark:border-gray-700 transition-colors">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold text-blue-600 tracking-tight">EduTrack</h1>

            <!-- Main View Switcher -->
            <div class="hidden md:flex space-x-6">
                <button onclick="switchMainView('dashboard')" id="nav-dashboard"
                    class="tab-active py-2">Dashboard</button>
                <button onclick="switchMainView('calendar')" id="nav-calendar"
                    class="tab-inactive py-2 hover:text-gray-700 dark:hover:text-gray-300">Calendar</button>
            </div>

            <div id="auth-section" class="flex items-center gap-3">
                <!-- Dark Mode Toggle -->
                <button onclick="toggleDarkMode()"
                    class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition">
                    <span id="dark-icon">ðŸŒ™</span>
                </button>

                <button onclick="toggleModal('login-modal', true)" id="login-btn-nav"
                    class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition hidden">
                    Login / Sign Up
                </button>
                <div id="user-info" class="hidden flex items-center gap-4">
                    <!-- Separate Data Buttons -->
                    <button onclick="exportCSV()"
                        class="text-sm font-medium text-gray-600 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 transition-colors">
                        Export CSV
                    </button>

                    <label
                        class="text-sm font-medium text-gray-600 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 transition-colors cursor-pointer">
                        Import CSV
                        <input type="file" id="csv-upload" class="hidden" accept=".csv" onchange="importCSV(this)">
                    </label>

                    <!-- Visual Separator -->
                    <div class="h-4 w-px bg-gray-300 dark:bg-gray-600 mx-2"></div>

                    <span id="user-email" class="text-sm font-medium hidden md:inline dark:text-gray-300"></span>
                    <button id="logout-btn" class="text-sm text-red-500 hover:text-red-700">Logout</button>
                    <span id="sync-status" class="text-xs text-gray-400">Synced</span>
                </div>
            </div>
        </div>
        <!-- Mobile Nav View Switcher -->
        <div class="md:hidden flex justify-center space-x-6 mt-4 border-t pt-2 dark:border-gray-700">
            <button onclick="switchMainView('dashboard')" id="nav-dashboard-mobile"
                class="text-blue-600 font-bold">Dashboard</button>
            <button onclick="switchMainView('calendar')" id="nav-calendar-mobile"
                class="text-gray-500 dark:text-gray-400">Calendar</button>
        </div>
    </nav>

    <!-- Main Content Container -->
    <div class="max-w-7xl mx-auto p-4 mt-6">

        <!-- VIEW: DASHBOARD -->
        <div id="view-dashboard">
            <div id="main-app-container">
                <!-- Dashboard Grid -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <!-- GPA Card -->
                    <div class="card p-6 rounded-xl shadow-sm flex flex-col justify-center relative">
                        <button onclick="exportPDF()"
                            class="absolute top-4 right-4 text-gray-400 hover:text-red-600 text-xs border border-gray-200 dark:border-gray-600 p-1 rounded"
                            title="Download PDF Report">
                            PDF Report
                        </button>
                        <h2 class="text-gray-500 dark:text-gray-400 text-sm uppercase tracking-wide">Cumulative GPA</h2>
                        <div class="text-4xl font-bold text-gray-900 dark:text-white mt-1" id="overall-gpa">0.00</div>
                    </div>

                    <!-- To-Do List -->
                    <div class="card p-6 rounded-xl shadow-sm col-span-2 overflow-y-auto max-h-48">
                        <h2 class="text-gray-500 dark:text-gray-400 text-sm uppercase tracking-wide mb-2">Upcoming
                            Deadlines</h2>
                        <div id="todo-list" class="space-y-2 text-sm">
                            <!-- Injected via JS -->
                            <p class="text-gray-400">No upcoming assignments.</p>
                        </div>
                    </div>
                </div>

                <!-- Controls -->
                <div class="flex justify-between items-center mb-4">
                    <div class="border-b border-gray-200 dark:border-gray-700 flex-grow overflow-x-auto">
                        <nav class="-mb-px flex space-x-8" id="class-tabs">
                            <!-- Tabs injected by JS -->
                        </nav>
                    </div>
                    <button id="add-class-btn" onclick="openClassModal()"
                        class="ml-4 bg-gray-900 dark:bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-gray-800 dark:hover:bg-blue-700 transition whitespace-nowrap">
                        + Add Class
                    </button>
                </div>

                <!-- Class Content Area -->
                <div id="class-content" class="min-h-[400px]">
                    <div class="text-center text-gray-400 mt-20">
                        <p>Select a class or add one to get started.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW: CALENDAR -->
        <div id="view-calendar" class="hidden">
            <div class="card rounded-xl shadow-sm p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800 dark:text-white" id="calendar-month-year"></h2>
                    <div class="flex space-x-2">
                        <button onclick="changeMonth(-1)"
                            class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded text-gray-600 dark:text-gray-300">
                            &lt; Prev
                        </button>
                        <button onclick="changeMonth(1)"
                            class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded text-gray-600 dark:text-gray-300">
                            Next &gt;
                        </button>
                    </div>
                </div>

                <!-- Calendar Grid -->
                <div
                    class="grid grid-cols-7 gap-px bg-gray-200 dark:bg-gray-700 border border-gray-200 dark:border-gray-700 rounded-lg overflow-hidden">
                    <!-- Weekday Headers -->
                    <div class="calendar-header bg-gray-50 p-2 text-center text-xs font-semibold text-gray-500">Sun
                    </div>
                    <div class="calendar-header bg-gray-50 p-2 text-center text-xs font-semibold text-gray-500">Mon
                    </div>
                    <div class="calendar-header bg-gray-50 p-2 text-center text-xs font-semibold text-gray-500">Tue
                    </div>
                    <div class="calendar-header bg-gray-50 p-2 text-center text-xs font-semibold text-gray-500">Wed
                    </div>
                    <div class="calendar-header bg-gray-50 p-2 text-center text-xs font-semibold text-gray-500">Thu
                    </div>
                    <div class="calendar-header bg-gray-50 p-2 text-center text-xs font-semibold text-gray-500">Fri
                    </div>
                    <div class="calendar-header bg-gray-50 p-2 text-center text-xs font-semibold text-gray-500">Sat
                    </div>

                    <!-- Days injected via JS -->
                    <div id="calendar-grid" class="contents"></div>
                </div>

                <!-- Legend -->
                <div id="calendar-legend" class="mt-4 flex flex-wrap gap-4 text-xs dark:text-gray-300">
                    <!-- Legend items injected via JS -->
                </div>
            </div>
        </div>

    </div>

    <!-- LOGIN MODAL -->
    <div id="login-modal"
        class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50"></div>
        <div class="modal-container bg-white w-11/12 md:max-w-md mx-auto rounded-lg shadow-lg z-50 overflow-y-auto">
            <div class="modal-content py-4 text-left px-6">
                <div class="flex justify-between items-center pb-3">
                    <p class="text-2xl font-bold">Welcome Back</p>
                    <div class="modal-close cursor-pointer z-50 p-2" onclick="toggleModal('login-modal', false)">
                        <span class="text-2xl">&times;</span>
                    </div>
                </div>


                <div class="relative flex py-2 items-center">
                    <div class="flex-grow border-t border-gray-300"></div>
                    <span class="flex-shrink mx-4 text-gray-400 text-sm">Or with Email</span>
                    <div class="flex-grow border-t border-gray-300"></div>
                </div>

                <!-- Email Form -->
                <form id="email-auth-form" class="space-y-4">
                    <div>
                        <label class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">Email</label>
                        <input type="email" id="auth-email"
                            class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" required>
                    </div>
                    <div>
                        <label class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">Password</label>
                        <input type="password" id="auth-password"
                            class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" required>
                    </div>
                    <div class="flex gap-2 pt-2">
                        <button type="button" id="signin-btn"
                            class="w-1/2 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700">Sign In</button>
                        <button type="button" id="signup-btn"
                            class="w-1/2 bg-gray-200 text-gray-700 py-2 rounded-lg hover:bg-gray-300">Sign Up</button>
                    </div>
                </form>
                <div id="auth-message" class="text-center text-sm mt-3 text-red-500 min-h-[20px]"></div>
            </div>
        </div>
    </div>

    <!-- ADD/EDIT CLASS MODAL -->
    <div id="class-modal"
        class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50"></div>
        <div
            class="modal-container bg-white w-11/12 md:max-w-md mx-auto rounded-lg shadow-lg z-50 overflow-y-auto max-h-[90vh]">
            <div class="modal-content py-4 text-left px-6">
                <div class="flex justify-between items-center pb-3">
                    <p class="text-2xl font-bold">Manage Class</p>
                    <div class="modal-close cursor-pointer z-50 p-2" onclick="closeClassModal()">
                        <span class="text-2xl">&times;</span>
                    </div>
                </div>
                <form id="class-form">
                    <input type="hidden" id="edit-class-id">
                    <div class="mb-4">
                        <label class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">Class Name</label>
                        <input
                            class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                            id="class-name" type="text" placeholder="e.g. Calculus I" required>
                    </div>

                    <div class="mb-4">
                        <label class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">Categories &
                            Weights (%)</label>
                        <div id="category-inputs" class="space-y-2">
                            <!-- Categories injected here -->
                        </div>
                        <button type="button" onclick="addCategoryInput()"
                            class="text-blue-500 text-sm mt-2 hover:underline font-bold">+ Add Category</button>
                    </div>

                    <div class="flex justify-end pt-2">
                        <button type="button" onclick="deleteClass()" id="delete-class-btn"
                            class="hidden text-red-500 mr-auto hover:text-red-700 font-bold border border-red-200 px-3 py-1 rounded">Delete
                            Class</button>
                        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Save
                            Class</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- ADD ASSIGNMENT MODAL -->
    <div id="assignment-modal"
        class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50"></div>
        <div
            class="modal-container bg-white w-11/12 md:max-w-md mx-auto rounded-lg shadow-lg z-50 overflow-y-auto max-h-[90vh]">
            <div class="modal-content py-4 text-left px-6">
                <div class="flex justify-between items-center pb-3">
                    <p class="text-2xl font-bold">Assignment</p>
                    <div class="modal-close cursor-pointer z-50 p-2" onclick="closeAssignmentModal()">
                        <span class="text-2xl">&times;</span>
                    </div>
                </div>
                <form id="assignment-form">
                    <input type="hidden" id="asg-class-id">
                    <input type="hidden" id="asg-id">

                    <div class="mb-4">
                        <label class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">Name</label>
                        <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700"
                            id="asg-name" type="text" required>
                    </div>

                    <div class="flex gap-4 mb-4">
                        <div class="w-1/2">
                            <label
                                class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">Category</label>
                            <select id="asg-category"
                                class="shadow border rounded w-full py-2 px-3 text-gray-700 bg-white" required>
                                <!-- Options filled via JS -->
                            </select>
                        </div>
                        <div class="w-1/2">
                            <label class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">Status</label>
                            <select id="asg-status"
                                class="shadow border rounded w-full py-2 px-3 text-gray-700 bg-white">
                                <option value="not-started">Not Started</option>
                                <option value="in-progress">In Progress</option>
                                <option value="completed">Completed</option>
                                <option value="submitted">Submitted</option>
                                <option value="na">N/A</option>
                            </select>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">Due Date
                            (Optional)</label>
                        <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700"
                            id="asg-date" type="date">
                    </div>

                    <div class="flex gap-4 mb-4">
                        <div class="w-1/2">
                            <label class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">Score</label>
                            <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700"
                                id="asg-score" type="number" step="0.1" placeholder="--">
                        </div>
                        <div class="w-1/2">
                            <label class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">Total</label>
                            <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700"
                                id="asg-total" type="number" value="100" step="0.1">
                        </div>
                    </div>

                    <div class="flex justify-end pt-2">
                        <button type="button" id="delete-asg-btn"
                            class="hidden text-red-500 mr-auto hover:text-red-700 font-bold border border-red-200 px-3 py-1 rounded"
                            onclick="deleteAssignment()">Delete</button>
                        <button type="submit"
                            class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Save</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- NOTES EDITOR MODAL -->
    <div id="note-modal"
        class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50"></div>
        <div
            class="modal-container bg-white w-11/12 md:max-w-2xl mx-auto rounded-lg shadow-lg z-50 overflow-y-auto max-h-[90vh]">
            <div class="modal-content py-4 text-left px-6">
                <div class="flex justify-between items-center pb-3">
                    <p class="text-2xl font-bold">Edit Note</p>
                    <div class="modal-close cursor-pointer z-50 p-2" onclick="closeNoteModal()">
                        <span class="text-2xl">&times;</span>
                    </div>
                </div>

                <div class="flex gap-4 mb-4">
                    <div class="w-2/3">
                        <label class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">Title</label>
                        <input
                            class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                            id="note-title" type="text" placeholder="Note Title" required>
                    </div>
                    <div class="w-1/3">
                        <label class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">Date</label>
                        <input
                            class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                            id="note-date" type="date">
                    </div>
                </div>

                <!-- Quill Editor Container -->
                <div id="editor-container" class="bg-white"></div>
                <input type="hidden" id="note-id">

                <div class="flex justify-end pt-4 gap-2">
                    <button type="button" onclick="exportNotePDF()"
                        class="mr-auto px-4 py-2 border border-gray-300 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">Export
                        PDF</button>

                    <button type="button" onclick="deleteNote()" id="delete-note-btn"
                        class="hidden text-red-500 hover:text-red-700 font-bold border border-red-200 px-3 py-1 rounded">Delete</button>
                    <button onclick="saveNote()"
                        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Save Note</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- SUPABASE CONFIGURATION ---
        const SUPABASE_URL = 'https://njgjgpiamweujgyknqtz.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_3bRvo_Zuppdi4ICnOtfjeA_VWfp6Zyx';
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- STATE MANAGEMENT ---
        let state = {
            classes: [],
            activeTab: null,
            user: null,
            currentView: 'dashboard',
            calendarDate: new Date()
        };

        // --- QUILL INIT ---
        // Register Font Sizes in PX for numbers
        var Size = Quill.import('attributors/style/size');
        Size.whitelist = ['10px', '12px', '14px', '16px', '18px', '20px', '24px', '30px', '36px', '48px'];
        Quill.register(Size, true);

        var quill = new Quill('#editor-container', {
            theme: 'snow',
            modules: {
                toolbar: [
                    [{ 'font': [] }],
                    [{ 'size': Size.whitelist }], // Use number based sizes
                    ['bold', 'italic', 'underline', 'strike'],
                    [{ 'color': [] }, { 'background': [] }],
                    [{ 'list': 'ordered' }, { 'list': 'bullet' }],
                    [{ 'indent': '-1' }, { 'indent': '+1' }],
                    ['link', 'image']
                ]
            }
        });

        // --- DATE HELPER (Fixes Off-by-one error) ---
        // Splits YYYY-MM-DD and creates local date to avoid UTC conversion shifts
        function getLocalDateObject(dateString) {
            if (!dateString) return null;
            // Check if ISO string (has T) or simple date
            if (dateString.includes('T')) {
                return new Date(dateString); // Treat ISO as is (though often best to stick to one format)
            }
            const [y, m, d] = dateString.split('-').map(Number);
            return new Date(y, m - 1, d);
        }

        function formatDateDisplay(dateString) {
            const date = getLocalDateObject(dateString);
            return date ? date.toLocaleDateString() : '';
        }

        // --- DARK MODE LOGIC ---
        function initDarkMode() {
            if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
                document.getElementById('dark-icon').innerText = 'â˜€ï¸';
            } else {
                document.documentElement.classList.remove('dark');
                document.getElementById('dark-icon').innerText = 'ðŸŒ™';
            }
        }

        function toggleDarkMode() {
            if (document.documentElement.classList.contains('dark')) {
                document.documentElement.classList.remove('dark');
                localStorage.setItem('theme', 'light');
                document.getElementById('dark-icon').innerText = 'ðŸŒ™';
            } else {
                document.documentElement.classList.add('dark');
                localStorage.setItem('theme', 'dark');
                document.getElementById('dark-icon').innerText = 'â˜€ï¸';
            }
        }
        initDarkMode();

        // --- ENCRYPTION / SCRAMBLING LOGIC (Base64) ---
        function scrambleData(data) {
            try {
                const jsonString = JSON.stringify(data);
                return btoa(unescape(encodeURIComponent(jsonString)));
            } catch (e) {
                console.error("Scramble failed", e);
                return null;
            }
        }

        function unscrambleData(scrambledString) {
            try {
                if (scrambledString.trim().startsWith('[') || scrambledString.trim().startsWith('{')) {
                    return JSON.parse(scrambledString);
                }
                const jsonString = decodeURIComponent(escape(atob(scrambledString)));
                return JSON.parse(jsonString);
            } catch (e) {
                console.error("Unscramble failed", e);
                try { return JSON.parse(scrambledString); } catch (e2) { return []; }
            }
        }

        // --- AUTHENTICATION ---
        async function checkUser() {
            const { data: { user } } = await supabaseClient.auth.getUser();
            state.user = user;
            updateAuthUI();
            if (user) {
                loadDataFromSupabase();
            } else {
                loadLocalData();
            }
        }

        function updateAuthUI() {
            const loginBtn = document.getElementById('login-btn-nav');
            const userInfo = document.getElementById('user-info');
            const userEmail = document.getElementById('user-email');

            if (state.user) {
                loginBtn.classList.add('hidden');
                userInfo.classList.remove('hidden');
                userEmail.innerText = state.user.email;
                toggleModal('login-modal', false);
            } else {
                loginBtn.classList.remove('hidden');
                userInfo.classList.add('hidden');
            }
        }



        document.getElementById('signin-btn').addEventListener('click', async () => {
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            const msg = document.getElementById('auth-message');
            msg.innerText = '';

            const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
            if (error) msg.innerText = error.message;
            else checkUser();
        });

        document.getElementById('signup-btn').addEventListener('click', async () => {
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            const msg = document.getElementById('auth-message');
            msg.innerText = '';

            const { data, error } = await supabaseClient.auth.signUp({ email, password });
            if (error) {
                msg.innerText = error.message;
            } else {
                msg.innerText = "Sign up successful! You are logged in.";
                msg.classList.remove('text-red-500');
                msg.classList.add('text-green-500');
                setTimeout(checkUser, 1500);
            }
        });

        document.getElementById('logout-btn').addEventListener('click', async () => {
            await supabaseClient.auth.signOut();
            state.user = null;
            state.classes = [];
            state.activeTab = null;
            updateAuthUI();
            document.getElementById('class-tabs').innerHTML = '';
            document.getElementById('class-content').innerHTML = '<div class="text-center text-gray-400 mt-20"><p>Please login to see your data.</p></div>';
            document.getElementById('overall-gpa').innerText = '0.00';
            document.getElementById('todo-list').innerHTML = '';
            renderCalendar();
        });

        // --- NAVIGATION LOGIC ---
        function switchMainView(view) {
            state.currentView = view;

            const dashBtn = document.getElementById('nav-dashboard');
            const calBtn = document.getElementById('nav-calendar');

            if (view === 'dashboard') {
                document.getElementById('view-dashboard').classList.remove('hidden');
                document.getElementById('view-calendar').classList.add('hidden');
                dashBtn.className = "tab-active py-2";
                calBtn.className = "tab-inactive py-2 hover:text-gray-700 dark:hover:text-gray-300";
            } else {
                document.getElementById('view-dashboard').classList.add('hidden');
                document.getElementById('view-calendar').classList.remove('hidden');
                dashBtn.className = "tab-inactive py-2 hover:text-gray-700 dark:hover:text-gray-300";
                calBtn.className = "tab-active py-2";
                renderCalendar();
            }
        }

        // --- IMPORT / EXPORT LOGIC ---
        function escapeCsv(text) {
            if (text === null || text === undefined) return '';
            const str = String(text);
            if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                return `"${str.replace(/"/g, '""')}"`;
            }
            return str;
        }

        function parseCSVRow(text) {
            const result = [];
            let curValue = '';
            let insideQuote = false;
            for (let i = 0; i < text.length; i++) {
                const char = text[i];
                if (char === '"') {
                    if (insideQuote && text[i + 1] === '"') {
                        curValue += '"';
                        i++;
                    } else {
                        insideQuote = !insideQuote;
                    }
                } else if (char === ',' && !insideQuote) {
                    result.push(curValue);
                    curValue = '';
                } else {
                    curValue += char;
                }
            }
            result.push(curValue);
            return result;
        }

        function exportCSV() {
            if (state.classes.length === 0) return alert("No data to export.");
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Type,ClassID,ClassName,CatID,CatName,CatWeight,AsgID,AsgName,AsgScore,AsgTotal,AsgDate,AsgStatus\n";
            state.classes.forEach(cls => {
                cls.categories.forEach(cat => {
                    csvContent += [
                        'Category',
                        escapeCsv(cls.id),
                        escapeCsv(cls.name),
                        escapeCsv(cat.id),
                        escapeCsv(cat.name),
                        escapeCsv(cat.weight),
                        '', '', '', '', '', ''
                    ].join(',') + '\n';
                });
                cls.assignments.forEach(asg => {
                    const cat = cls.categories.find(c => c.id === asg.categoryId);
                    const catName = cat ? cat.name : "Unknown";
                    csvContent += [
                        'Assignment',
                        escapeCsv(cls.id),
                        escapeCsv(cls.name),
                        escapeCsv(asg.categoryId),
                        escapeCsv(catName),
                        '',
                        escapeCsv(asg.id),
                        escapeCsv(asg.name),
                        escapeCsv(asg.score),
                        escapeCsv(asg.total),
                        escapeCsv(asg.dueDate),
                        escapeCsv(asg.status)
                    ].join(',') + '\n';
                });
            });
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "edutrack_export.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function importCSV(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function (e) {
                const text = e.target.result;
                const rows = text.replace(/\r\n/g, '\n').split('\n').slice(1);
                const newClasses = [];
                const classMap = {};

                rows.forEach(row => {
                    if (!row.trim()) return;
                    const cols = parseCSVRow(row);
                    if (cols.length < 4) return;

                    const type = cols[0];
                    const classId = cols[1];
                    const className = cols[2];

                    if (!classMap[classId]) {
                        classMap[classId] = {
                            id: classId,
                            name: className,
                            categories: [],
                            assignments: [],
                            notes: []
                        };
                        newClasses.push(classMap[classId]);
                    }

                    if (type === 'Category') {
                        classMap[classId].categories.push({
                            id: cols[3],
                            name: cols[4],
                            weight: cols[5]
                        });
                    } else if (type === 'Assignment') {
                        classMap[classId].assignments.push({
                            id: cols[6],
                            categoryId: cols[3],
                            name: cols[7],
                            score: cols[8],
                            total: cols[9],
                            dueDate: cols[10],
                            status: cols[11]
                        });
                    }
                });

                if (newClasses.length > 0) {
                    if (confirm(`Found ${newClasses.length} classes. This will overwrite current data. Continue?`)) {
                        state.classes = newClasses;
                        if (state.classes.length > 0) state.activeTab = state.classes[0].id;
                        saveData();
                        render();
                        alert("Import successful!");
                    }
                } else {
                    alert("Could not parse CSV data. Format might be incorrect.");
                }
                input.value = '';
            };
            reader.readAsText(file);
        }

        function exportPDF() {
            if (state.classes.length === 0) return alert("No classes to export.");

            // Create element
            const tempDiv = document.createElement('div');

            // STYLE FIXES: Ensure it has width and is attached to body
            tempDiv.style.width = '800px';
            tempDiv.style.padding = '20px';
            tempDiv.style.fontFamily = 'Inter, sans-serif';
            tempDiv.style.color = 'black';
            tempDiv.style.backgroundColor = 'white';

            // Position off-screen but keep it rendered
            tempDiv.style.position = 'absolute';
            tempDiv.style.left = '-9999px';
            tempDiv.style.top = '0px';

            // IMPORTANT: Append to body BEFORE generating PDF
            document.body.appendChild(tempDiv);

            let overallGPA = document.getElementById('overall-gpa').innerText;
            let header = `
                <div style="text-align: center; margin-bottom: 30px; border-bottom: 2px solid #2563eb; padding-bottom: 10px;">
                    <h1 style="color: #2563eb; margin: 0;">EduTrack Report</h1>
                    <p style="color: #6b7280; margin: 5px 0;">Generated on ${new Date().toLocaleDateString()}</p>
                    <h2 style="margin: 10px 0;">Cumulative GPA: ${overallGPA}</h2>
                </div>
            `;
            tempDiv.innerHTML = header;

            state.classes.forEach((cls, index) => {
                const currentGrade = calculateClassGrade(cls);
                const letterGrade = getLetterGrade(currentGrade);
                const gradeColor = letterGrade === 'A' ? '#16a34a' : letterGrade === 'F' ? '#ef4444' : '#2563eb';

                let sortedAssignments = [...cls.assignments].sort((a, b) => {
                    if (a.dueDate && b.dueDate) return new Date(b.dueDate) - new Date(a.dueDate);
                    return 0;
                });

                let assignmentsRows = '';
                if (sortedAssignments.length === 0) {
                    assignmentsRows = '<tr><td colspan="4" style="text-align:center; padding: 10px; color: #999;">No assignments found.</td></tr>';
                } else {
                    sortedAssignments.forEach(asg => {
                        const cat = cls.categories.find(c => c.id === asg.categoryId);
                        const catName = cat ? cat.name : "Unknown";
                        const scoreDisplay = (asg.score !== null && asg.score !== "") ? `${asg.score}/${asg.total}` : '-';
                        const percent = (asg.score !== null && asg.score !== "") ? Math.round((asg.score / asg.total) * 100) + '%' : '';

                        assignmentsRows += `
                            <tr style="border-bottom: 1px solid #e5e7eb;">
                                <td style="padding: 8px;">${asg.name}</td>
                                <td style="padding: 8px;">${catName}</td>
                                <td style="padding: 8px;">${formatDateDisplay(asg.dueDate) || '-'}</td>
                                <td style="padding: 8px; font-weight: bold;">${scoreDisplay} (${percent})</td>
                            </tr>
                        `;
                    });
                }
                const pageBreak = `<div style="page-break-after: always;"></div>`;
                const classHtml = `
                    <div style="margin-bottom: 20px; page-break-inside: avoid;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h2 style="font-size: 24px; font-weight: bold; margin: 0;">${cls.name}</h2>
                            <div style="text-align: right;">
                                <span style="font-size: 24px; font-weight: bold; color: ${gradeColor};">${currentGrade ? currentGrade.toFixed(2) : '--'}%</span>
                                <span style="font-size: 18px; color: #6b7280; margin-left: 5px;">(${letterGrade})</span>
                            </div>
                        </div>
                        <div style="margin-bottom: 20px; background: #f9fafb; padding: 10px; border-radius: 8px;">
                            <h3 style="font-size: 14px; margin: 0 0 5px 0; text-transform: uppercase; color: #6b7280;">Weighting</h3>
                            <ul style="margin: 0; padding-left: 20px; font-size: 14px;">
                                ${cls.categories.map(cat => `<li>${cat.name}: ${cat.weight}%</li>`).join('')}
                            </ul>
                        </div>
                        <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                            <thead>
                                <tr style="background-color: #f3f4f6; text-align: left;">
                                    <th style="padding: 8px; border-bottom: 2px solid #e5e7eb;">Assignment</th>
                                    <th style="padding: 8px; border-bottom: 2px solid #e5e7eb;">Category</th>
                                    <th style="padding: 8px; border-bottom: 2px solid #e5e7eb;">Due Date</th>
                                    <th style="padding: 8px; border-bottom: 2px solid #e5e7eb;">Score</th>
                                </tr>
                            </thead>
                            <tbody>${assignmentsRows}</tbody>
                        </table>
                    </div>
                    <br/>
                `;
                tempDiv.innerHTML += classHtml;
            });

            const opt = {
                margin: 0.5,
                filename: 'edutrack_report.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true },
                jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
            };

            // Generate PDF and remove element afterward
            html2pdf().set(opt).from(tempDiv).save().then(() => {
                document.body.removeChild(tempDiv);
            });
        }
        // --- DATA PERSISTENCE ---
        async function saveData() {
            if (state.user) {
                document.getElementById('sync-status').innerText = 'Saving...';
                const scrambled = scrambleData(state.classes);
                const { data: existingData } = await supabaseClient.from('user_data').select('id').eq('user_id', state.user.id).single();
                const dataToSave = { scrambled: scrambled };
                const updatePayload = { data: dataToSave, updated_at: new Date() };
                if (existingData) {
                    await supabaseClient.from('user_data').update(updatePayload).eq('user_id', state.user.id);
                } else {
                    await supabaseClient.from('user_data').insert([{ user_id: state.user.id, data: dataToSave }]);
                }
                setTimeout(() => { document.getElementById('sync-status').innerText = 'Saved'; }, 1000);
            } else {
                localStorage.setItem('edutrack_data', JSON.stringify(state.classes));
            }
        }

        function loadLocalData() {
            const stored = localStorage.getItem('edutrack_data');
            if (stored) {
                state.classes = JSON.parse(stored);
                if (state.classes.length > 0 && !state.activeTab) state.activeTab = state.classes[0].id;
                render();
            }
        }

        async function loadDataFromSupabase() {
            document.getElementById('sync-status').innerText = 'Loading...';
            const { data, error } = await supabaseClient.from('user_data').select('data').eq('user_id', state.user.id).single();
            if (data && data.data) {
                if (data.data.scrambled) {
                    state.classes = unscrambleData(data.data.scrambled);
                } else {
                    state.classes = Array.isArray(data.data) ? data.data : [];
                }
                if (state.classes.length > 0) state.activeTab = state.classes[0].id;
                render();
            }
            document.getElementById('sync-status').innerText = 'Synced';
        }

        // --- CORE LOGIC (GPA & GRADES) ---
        function calculateClassGrade(cls) {
            let totalWeightUsed = 0;
            let weightedSum = 0;
            cls.categories.forEach(cat => {
                const assignments = cls.assignments.filter(a => a.categoryId === cat.id && a.score !== null && a.score !== "");
                if (assignments.length > 0) {
                    let catTotalPoints = 0;
                    let catEarnedPoints = 0;
                    assignments.forEach(a => {
                        catEarnedPoints += parseFloat(a.score);
                        catTotalPoints += parseFloat(a.total);
                    });
                    if (catTotalPoints > 0) {
                        const catPercentage = (catEarnedPoints / catTotalPoints);
                        weightedSum += catPercentage * parseFloat(cat.weight);
                        totalWeightUsed += parseFloat(cat.weight);
                    }
                }
            });
            if (totalWeightUsed === 0) return null;
            return (weightedSum / totalWeightUsed) * 100;
        }

        function getLetterGrade(percentage) {
            if (percentage === null) return 'N/A';
            if (percentage >= 90) return 'A';
            if (percentage >= 80) return 'B';
            if (percentage >= 70) return 'C';
            if (percentage >= 60) return 'D';
            return 'F';
        }

        function getGPAFromLetter(letter) {
            if (letter === 'A') return 4.0;
            if (letter === 'B') return 3.0;
            if (letter === 'C') return 2.0;
            if (letter === 'D') return 1.0;
            return 0.0;
        }

        function calculateOverallGPA() {
            let totalGPA = 0;
            let count = 0;
            state.classes.forEach(cls => {
                const grade = calculateClassGrade(cls);
                if (grade !== null) {
                    totalGPA += getGPAFromLetter(getLetterGrade(grade));
                    count++;
                }
            });
            const finalGPA = count === 0 ? 0 : (totalGPA / count);
            document.getElementById('overall-gpa').innerText = finalGPA.toFixed(2);
        }

        function getStatusLabel(status) {
            switch (status) {
                case 'in-progress': return 'In Progress';
                case 'completed': return 'Completed';
                case 'submitted': return 'Submitted';
                case 'na': return 'N/A';
                default: return 'Not Started';
            }
        }

        // --- CALENDAR LOGIC ---
        function stringToColor(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
            const hue = Math.abs(hash % 360);
            return `hsl(${hue}, 70%, 85%)`;
        }
        function stringToTextColor(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
            const hue = Math.abs(hash % 360);
            return `hsl(${hue}, 80%, 30%)`;
        }

        function changeMonth(offset) {
            state.calendarDate.setMonth(state.calendarDate.getMonth() + offset);
            renderCalendar();
        }

        function renderCalendar() {
            const grid = document.getElementById('calendar-grid');
            const monthLabel = document.getElementById('calendar-month-year');
            const legend = document.getElementById('calendar-legend');
            grid.innerHTML = '';
            legend.innerHTML = '';
            const year = state.calendarDate.getFullYear();
            const month = state.calendarDate.getMonth();
            const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            monthLabel.innerText = `${monthNames[month]} ${year}`;
            state.classes.forEach(cls => {
                const bg = stringToColor(cls.id);
                const item = document.createElement('div');
                item.className = 'flex items-center gap-1';
                item.innerHTML = `<span class="w-3 h-3 rounded-full" style="background-color:${bg}"></span><span>${cls.name}</span>`;
                legend.appendChild(item);
            });
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startDayIndex = firstDay.getDay();
            for (let i = 0; i < startDayIndex; i++) {
                const cell = document.createElement('div');
                cell.className = 'bg-gray-100 dark:bg-gray-800 min-h-[100px] border-b border-r border-gray-200 dark:border-gray-700';
                grid.appendChild(cell);
            }
            for (let day = 1; day <= daysInMonth; day++) {
                const cell = document.createElement('div');
                cell.className = 'calendar-day bg-white dark:bg-gray-800 border-b border-r border-gray-200 dark:border-gray-700 p-1 relative';
                const dayNum = document.createElement('div');
                dayNum.className = 'text-xs font-bold text-gray-500 dark:text-gray-400 mb-1';
                dayNum.innerText = day;
                cell.appendChild(dayNum);
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                state.classes.forEach(cls => {
                    cls.assignments.forEach(asg => {
                        if (asg.dueDate === dateStr) {
                            const event = document.createElement('div');
                            event.className = 'calendar-event';
                            event.style.backgroundColor = stringToColor(cls.id);
                            event.style.color = stringToTextColor(cls.id);
                            event.innerText = asg.name;
                            event.title = `${asg.name} (${cls.name})`;
                            event.onclick = (e) => {
                                e.stopPropagation();
                                state.activeTab = cls.id;
                                editAssignment(asg.id);
                            };
                            cell.appendChild(event);
                        }
                    });
                });
                grid.appendChild(cell);
            }
        }

        // --- NOTES LOGIC ---
        function openNoteModal(noteId = null) {
            const cls = state.classes.find(c => c.id === state.activeTab);
            const editor = document.getElementById('editor-container');
            const titleInput = document.getElementById('note-title');
            const dateInput = document.getElementById('note-date');
            const deleteBtn = document.getElementById('delete-note-btn');
            const idInput = document.getElementById('note-id');

            if (noteId) {
                const note = cls.notes.find(n => n.id === noteId);
                titleInput.value = note.title;
                quill.root.innerHTML = note.content;
                idInput.value = note.id;
                // If note.date is simple YYYY-MM-DD, use it. If ISO, slice it.
                dateInput.value = note.date.includes('T') ? note.date.slice(0, 10) : note.date;
                deleteBtn.classList.remove('hidden');
            } else {
                titleInput.value = '';
                quill.root.innerHTML = '';
                idInput.value = '';
                // Default to today using local YYYY-MM-DD
                const now = new Date();
                dateInput.value = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0') + '-' + String(now.getDate()).padStart(2, '0');
                deleteBtn.classList.add('hidden');
            }
            toggleModal('note-modal', true);
        }

        function closeNoteModal() {
            toggleModal('note-modal', false);
        }

        function saveNote() {
            const cls = state.classes.find(c => c.id === state.activeTab);
            const id = document.getElementById('note-id').value;
            const title = document.getElementById('note-title').value;
            const content = quill.root.innerHTML;
            const dateVal = document.getElementById('note-date').value;

            if (!title) return alert("Please enter a title");

            // Use the user-picked date directly (YYYY-MM-DD) or fallback to today
            let finalDate = dateVal;
            if (!finalDate) {
                const now = new Date();
                finalDate = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0') + '-' + String(now.getDate()).padStart(2, '0');
            }

            if (!cls.notes) cls.notes = [];

            if (id) {
                // Update
                const note = cls.notes.find(n => n.id === id);
                note.title = title;
                note.content = content;
                note.date = finalDate;
            } else {
                // Create
                cls.notes.push({
                    id: 'note_' + Date.now(),
                    title: title,
                    content: content,
                    date: finalDate
                });
            }
            saveData();
            render();
            closeNoteModal();
        }

        function deleteNote() {
            if (confirm("Delete this note?")) {
                const cls = state.classes.find(c => c.id === state.activeTab);
                const id = document.getElementById('note-id').value;
                cls.notes = cls.notes.filter(n => n.id !== id);
                saveData();
                render();
                closeNoteModal();
            }
        }
       function exportNotePDF() {
            const title = document.getElementById('note-title').value || "Untitled Note";
            const content = quill.root.innerHTML; // Get HTML from Quill
            const dateVal = document.getElementById('note-date').value;
            
            const element = document.createElement('div');
            element.style.width = '800px'; 
            element.style.padding = '40px';
            element.style.fontFamily = 'Inter, sans-serif';
            element.style.color = 'black';
            element.style.backgroundColor = 'white';
            
            // Positioning fix
            element.style.position = 'absolute';
            element.style.left = '-9999px';
            element.style.top = '0px'; // Ensure top is 0 so it doesn't float into negative space

            element.innerHTML = `
                <div style="border-bottom: 2px solid #2563eb; padding-bottom: 10px; margin-bottom: 20px;">
                    <h1 style="margin: 0; color: #2563eb;">${title}</h1>
                    <p style="margin: 5px 0; color: #666; font-size: 0.9em;">${formatDateDisplay(dateVal)}</p>
                </div>
                <div class="ql-editor" style="padding: 0;"> 
                    ${content}
                </div>
            `;
            // Note: Added class "ql-editor" above to inherit Quill styles if needed

            document.body.appendChild(element);

            const opt = {
                margin:       0.5,
                filename:     `${title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.pdf`,
                image:        { type: 'jpeg', quality: 0.98 },
                html2canvas:  { scale: 2, useCORS: true, scrollY: 0 }, // scrollY: 0 helps prevent blank tops
                jsPDF:        { unit: 'in', format: 'letter', orientation: 'portrait' }
            };

            html2pdf().set(opt).from(element).save().then(() => {
                document.body.removeChild(element);
            });
        }
        // --- UI RENDERING ---
        function renderTodoList() {
            const listEl = document.getElementById('todo-list');
            listEl.innerHTML = '';
            let allAssignments = [];
            state.classes.forEach(cls => {
                cls.assignments.forEach(asg => {
                    if (asg.status !== 'completed' && asg.status !== 'submitted' && asg.status !== 'na') {
                        allAssignments.push({ ...asg, className: cls.name, classId: cls.id });
                    }
                });
            });
            allAssignments.sort((a, b) => {
                if (!a.dueDate) return 1;
                if (!b.dueDate) return -1;
                return new Date(a.dueDate) - new Date(b.dueDate);
            });
            if (allAssignments.length === 0) {
                listEl.innerHTML = '<p class="text-gray-400 italic">No pending assignments.</p>';
                return;
            }
            const today = new Date(); today.setHours(0, 0, 0, 0);

            allAssignments.forEach(asg => {
                let timeText = formatDateDisplay(asg.dueDate) || 'No Date';
                let timeColor = 'bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-300';
                if (asg.dueDate) {
                    const dueZero = getLocalDateObject(asg.dueDate);
                    if (dueZero < today) {
                        timeColor = 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200';
                        timeText += ' (Overdue)';
                    } else if (dueZero.getTime() === today.getTime()) {
                        timeColor = 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200';
                        timeText = 'Today';
                    } else {
                        timeColor = 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200';
                    }
                }
                const item = document.createElement('div');
                item.className = 'flex justify-between items-center bg-gray-50 dark:bg-gray-800 p-2 rounded border border-gray-100 dark:border-gray-700 cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700';
                item.onclick = () => {
                    state.activeTab = asg.classId;
                    switchMainView('dashboard');
                    render();
                    editAssignment(asg.id);
                };
                item.innerHTML = `
                    <div>
                        <span class="font-medium text-gray-800 dark:text-gray-200">${asg.name}</span>
                        <span class="text-xs text-gray-500 dark:text-gray-400 block">${asg.className}</span>
                    </div>
                    <span class="text-xs font-semibold px-2 py-1 rounded ${timeColor}">${timeText}</span>
                `;
                listEl.appendChild(item);
            });
        }

        function render() {
            renderTodoList();

            if (state.currentView === 'calendar') {
                renderCalendar();
            }

            const tabsContainer = document.getElementById('class-tabs');
            const contentContainer = document.getElementById('class-content');

            tabsContainer.innerHTML = '';

            if (state.classes.length === 0) {
                contentContainer.innerHTML = '<div class="text-center text-gray-400 mt-20"><p>No classes added yet.</p></div>';
                calculateOverallGPA();
                return;
            }

            state.classes.forEach(cls => {
                const isActive = cls.id === state.activeTab;
                const tabBtn = document.createElement('a');
                tabBtn.className = `cursor-pointer whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm ${isActive ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 hover:border-gray-300 dark:hover:border-gray-600'}`;
                tabBtn.innerText = cls.name;
                tabBtn.onclick = () => { state.activeTab = cls.id; render(); };
                tabsContainer.appendChild(tabBtn);
            });

            const activeClass = state.classes.find(c => c.id === state.activeTab);
            if (activeClass) {
                if (!activeClass.notes) activeClass.notes = [];

                const currentGrade = calculateClassGrade(activeClass);
                const letterGrade = getLetterGrade(currentGrade);
                const gradeColorClass = `grade-${letterGrade}`;

                // --- ASSIGNMENTS HTML ---
                let assignmentsHtml = '';
                if (!activeClass.assignments || activeClass.assignments.length === 0) {
                    assignmentsHtml = `<div class="text-center text-gray-400 py-10">No assignments yet.</div>`;
                    if (!activeClass.assignments) activeClass.assignments = [];
                } else {
                    assignmentsHtml = `<div class="bg-white dark:bg-gray-800 shadow overflow-hidden sm:rounded-md mt-4"><ul class="divide-y divide-gray-200 dark:divide-gray-700">`;
                    activeClass.assignments.sort((a, b) => {
                        if (a.dueDate && b.dueDate) return new Date(b.dueDate) - new Date(a.dueDate);
                        return 0;
                    });
                    activeClass.assignments.forEach(asg => {
                        const cat = activeClass.categories.find(c => c.id === asg.categoryId);
                        const catName = cat ? cat.name : 'Unknown';
                        const scoreDisplay = (asg.score !== null && asg.score !== "") ? `${asg.score}/${asg.total}` : '-';
                        const percent = (asg.score !== null && asg.score !== "") ? Math.round((asg.score / asg.total) * 100) : null;
                        let percentColor = 'text-gray-500 dark:text-gray-400';
                        if (percent !== null) {
                            percentColor = percent >= 90 ? 'text-green-600' : percent < 60 ? 'text-red-500' : 'text-gray-500 dark:text-gray-400';
                        }
                        const statusKey = asg.status || 'not-started';
                        const statusBadgeHtml = `<span class="text-[10px] uppercase font-bold px-2 py-0.5 rounded status-${statusKey} mr-2">${getStatusLabel(statusKey)}</span>`;
                        const dateBadge = asg.dueDate ? `<span class="ml-2 text-xs text-gray-400 border border-gray-200 dark:border-gray-600 rounded px-1">${formatDateDisplay(asg.dueDate)}</span>` : '';

                        assignmentsHtml += `
                            <li class="px-4 py-4 sm:px-6 flex justify-between items-center cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 group" onclick="editAssignment('${asg.id}')">
                                <div>
                                    <div class="flex items-center mb-1">
                                        <p class="text-sm font-medium text-blue-600 dark:text-blue-400 truncate mr-2">${asg.name}</p>
                                        ${statusBadgeHtml}
                                    </div>
                                    <div class="flex items-center">
                                        <p class="text-xs text-gray-500 dark:text-gray-400">${catName}</p>
                                        ${dateBadge}
                                    </div>
                                </div>
                                <div class="flex items-center gap-4">
                                    <div class="text-right">
                                        <p class="text-sm font-bold text-gray-900 dark:text-gray-100">${scoreDisplay}</p>
                                        <p class="text-xs ${percentColor}">${percent !== null ? percent + '%' : 'Pending'}</p>
                                    </div>
                                    <span class="text-gray-300 text-sm group-hover:text-gray-500">Edit</span>
                                </div>
                            </li>
                        `;
                    });
                    assignmentsHtml += `</ul></div>`;
                }

                // --- NOTES HTML ---
                let notesHtml = '';
                if (activeClass.notes.length === 0) {
                    notesHtml = `<p class="text-xs text-gray-400 mt-2">No notes added.</p>`;
                } else {
                    notesHtml = `<div class="space-y-2 mt-2">`;
                    activeClass.notes.forEach(note => {
                        notesHtml += `
                            <div onclick="openNoteModal('${note.id}')" class="p-2 bg-gray-50 dark:bg-gray-800 rounded border border-gray-200 dark:border-gray-700 cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700">
                                <p class="font-bold text-sm text-gray-800 dark:text-gray-200">${note.title}</p>
                                <p class="text-xs text-gray-500">${formatDateDisplay(note.date)}</p>
                            </div>
                        `;
                    });
                    notesHtml += `</div>`;
                }

                contentContainer.innerHTML = `
                    <div class="flex flex-col md:flex-row gap-6">
                        <div class="md:w-1/3 space-y-4">
                            <!-- GRADE CARD -->
                            <div class="card p-6 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 relative">
                                <button onclick="openClassModal('${activeClass.id}')" class="absolute top-4 right-4 text-gray-400 hover:text-blue-600 border border-gray-200 dark:border-gray-600 rounded px-2 text-xs font-semibold uppercase">Edit Class</button>
                                <h3 class="text-gray-500 dark:text-gray-400 text-xs uppercase tracking-wide">Current Grade</h3>
                                <div class="flex items-baseline mt-2">
                                    <span class="text-5xl font-extrabold ${gradeColorClass}">${currentGrade ? currentGrade.toFixed(2) : '--'}%</span>
                                    <span class="ml-2 text-2xl font-medium text-gray-400">(${letterGrade})</span>
                                </div>
                                <div class="mt-4 pt-4 border-t border-gray-100 dark:border-gray-700">
                                    <h4 class="text-xs font-semibold text-gray-400 mb-2">Category Breakdown</h4>
                                    <div class="space-y-2">
                                        ${activeClass.categories.map(cat => {
                    const catAsgs = activeClass.assignments.filter(a => a.categoryId === cat.id && a.score);
                    let earned = 0, total = 0;
                    catAsgs.forEach(a => { earned += parseFloat(a.score); total += parseFloat(a.total); });
                    const avg = total > 0 ? Math.round((earned / total) * 100) : 0;
                    return `
                                                <div class="flex justify-between text-sm">
                                                    <span class="text-gray-600 dark:text-gray-300">${cat.name} <span class="text-xs text-gray-400">(${cat.weight}%)</span></span>
                                                    <span class="font-bold ${total > 0 ? 'text-gray-700 dark:text-gray-200' : 'text-gray-300'}">${total > 0 ? avg + '%' : '--'}</span>
                                                </div>
                                            `;
                }).join('')}
                                    </div>
                                </div>
                            </div>

                            <!-- NOTES CARD -->
                            <div class="card p-6 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700">
                                <div class="flex justify-between items-center mb-2">
                                    <h3 class="text-gray-500 dark:text-gray-400 text-xs uppercase tracking-wide">Class Notes</h3>
                                    <button onclick="openNoteModal()" class="text-xs text-blue-600 hover:text-blue-800 font-bold">+ New</button>
                                </div>
                                ${notesHtml}
                            </div>
                        </div>

                        <div class="md:w-2/3">
                            <div class="flex justify-between items-center mb-2">
                                <h3 class="text-lg font-bold text-gray-800 dark:text-gray-200">Assignments</h3>
                                <button onclick="openAssignmentModal()" class="bg-blue-600 text-white text-sm px-3 py-1.5 rounded hover:bg-blue-700 shadow-sm">
                                    + Add Assignment
                                </button>
                            </div>
                            ${assignmentsHtml}
                        </div>
                    </div>
                `;
            }
            calculateOverallGPA();
        }

        // --- MODAL & FORM HANDLERS ---

        function toggleModal(modalID, forceState = null) {
            const modal = document.getElementById(modalID);
            const isHidden = modal.classList.contains('opacity-0');
            const shouldShow = forceState !== null ? forceState : isHidden;
            if (shouldShow) {
                modal.classList.remove('opacity-0', 'pointer-events-none');
                document.body.classList.add('modal-active');
            } else {
                modal.classList.add('opacity-0', 'pointer-events-none');
                document.body.classList.remove('modal-active');
            }
        }

        function openClassModal(classId = null) {
            const form = document.getElementById('class-form');
            const deleteBtn = document.getElementById('delete-class-btn');
            const catInputs = document.getElementById('category-inputs');
            catInputs.innerHTML = '';
            if (classId) {
                const cls = state.classes.find(c => c.id === classId);
                document.getElementById('edit-class-id').value = cls.id;
                document.getElementById('class-name').value = cls.name;
                cls.categories.forEach(cat => addCategoryInput(cat.name, cat.weight, cat.id));
                deleteBtn.classList.remove('hidden');
            } else {
                document.getElementById('edit-class-id').value = '';
                document.getElementById('class-name').value = '';
                form.reset();
                addCategoryInput('Assignments', 100);
                deleteBtn.classList.add('hidden');
            }
            toggleModal('class-modal', true);
        }

        function closeClassModal() { toggleModal('class-modal', false); }

        function addCategoryInput(name = '', weight = '', id = null) {
            const wrapper = document.createElement('div');
            wrapper.className = 'flex gap-2 category-row items-center';
            const idVal = id ? id : 'new_' + Date.now() + Math.random();
            wrapper.innerHTML = `
                <input type="text" placeholder="Category Name" class="cat-name flex-grow shadow appearance-none border rounded py-2 px-3 text-gray-700 dark:text-white dark:bg-gray-700 dark:border-gray-600" value="${name}" required>
                <input type="number" placeholder="%" class="cat-weight w-20 shadow appearance-none border rounded py-2 px-3 text-gray-700 dark:text-white dark:bg-gray-700 dark:border-gray-600" value="${weight}" required>
                <input type="hidden" class="cat-id" value="${idVal}">
                <button type="button" onclick="this.closest('.category-row').remove()" class="text-red-500 hover:text-red-700 px-2 font-bold text-xl leading-none">&times;</button>
            `;
            document.getElementById('category-inputs').appendChild(wrapper);
        }

        document.getElementById('class-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const id = document.getElementById('edit-class-id').value;
            const name = document.getElementById('class-name').value;
            const categories = [];
            document.querySelectorAll('.category-row').forEach(row => {
                categories.push({
                    id: row.querySelector('.cat-id').value,
                    name: row.querySelector('.cat-name').value,
                    weight: row.querySelector('.cat-weight').value
                });
            });
            if (categories.length === 0) {
                alert("Please add at least one category.");
                return;
            }
            if (id) {
                const cls = state.classes.find(c => c.id === id);
                cls.name = name;
                cls.categories = categories;
            } else {
                const newClass = {
                    id: 'cls_' + Date.now(),
                    name: name,
                    categories: categories,
                    assignments: [],
                    notes: []
                };
                state.classes.push(newClass);
                state.activeTab = newClass.id;
            }
            saveData();
            render();
            closeClassModal();
        });

        function deleteClass() {
            if (confirm('Are you sure? This will delete all assignments for this class.')) {
                const id = document.getElementById('edit-class-id').value;
                state.classes = state.classes.filter(c => c.id !== id);
                state.activeTab = state.classes.length > 0 ? state.classes[0].id : null;
                saveData();
                render();
                closeClassModal();
            }
        }

        function openAssignmentModal() {
            if (!state.activeTab) return alert("Select a class first");
            const activeClass = state.classes.find(c => c.id === state.activeTab);
            const select = document.getElementById('asg-category');
            select.innerHTML = '';
            if (activeClass.categories.length === 0) {
                alert("This class has no categories. Please edit the class to add categories.");
                return;
            }
            activeClass.categories.forEach(cat => {
                const opt = document.createElement('option');
                opt.value = cat.id;
                opt.innerText = `${cat.name} (${cat.weight}%)`;
                select.appendChild(opt);
            });
            document.getElementById('asg-class-id').value = activeClass.id;
            document.getElementById('asg-id').value = '';
            document.getElementById('delete-asg-btn').classList.add('hidden');
            document.getElementById('assignment-form').reset();
            document.getElementById('asg-status').value = 'not-started';
            toggleModal('assignment-modal', true);
        }

        function editAssignment(asgId) {
            const activeClass = state.classes.find(c => c.id === state.activeTab);
            const asg = activeClass.assignments.find(a => a.id === asgId);
            openAssignmentModal();
            document.getElementById('asg-id').value = asg.id;
            document.getElementById('asg-name').value = asg.name;
            document.getElementById('asg-category').value = asg.categoryId;
            document.getElementById('asg-score').value = asg.score;
            document.getElementById('asg-total').value = asg.total;
            document.getElementById('asg-date').value = asg.dueDate || '';
            document.getElementById('asg-status').value = asg.status || 'not-started';
            document.getElementById('delete-asg-btn').classList.remove('hidden');
        }

        function deleteAssignment() {
            if (confirm('Are you sure you want to delete this assignment?')) {
                const classId = document.getElementById('asg-class-id').value;
                const asgId = document.getElementById('asg-id').value;
                const cls = state.classes.find(c => c.id === classId);
                cls.assignments = cls.assignments.filter(a => a.id !== asgId);
                saveData();
                render();
                closeAssignmentModal();
            }
        }

        function closeAssignmentModal() { toggleModal('assignment-modal', false); }

        document.getElementById('assignment-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const classId = document.getElementById('asg-class-id').value;
            const asgId = document.getElementById('asg-id').value;
            const name = document.getElementById('asg-name').value;
            const catId = document.getElementById('asg-category').value;
            const score = document.getElementById('asg-score').value;
            const total = document.getElementById('asg-total').value;
            const date = document.getElementById('asg-date').value;
            const status = document.getElementById('asg-status').value;
            const cls = state.classes.find(c => c.id === classId);
            if (asgId) {
                const asg = cls.assignments.find(a => a.id === asgId);
                asg.name = name;
                asg.categoryId = catId;
                asg.score = score;
                asg.total = total;
                asg.dueDate = date;
                asg.status = status;
            } else {
                cls.assignments.push({
                    id: 'asg_' + Date.now(),
                    categoryId: catId,
                    name: name,
                    score: score,
                    total: total,
                    dueDate: date,
                    status: status,
                    created_at: new Date().toISOString()
                });
            }
            saveData();
            render();
            closeAssignmentModal();
        });

        // Initialize App
        checkUser();

    </script>
</body>

</html>