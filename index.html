<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduTrack - Smart Assignment Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Library for PDF Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .tab-active { border-bottom: 2px solid #2563eb; color: #2563eb; font-weight: 600; }
        .tab-inactive { color: #6b7280; }
        .grade-A { color: #16a34a; }
        .grade-B { color: #84cc16; }
        .grade-C { color: #eab308; }
        .grade-D { color: #f97316; }
        .grade-F { color: #ef4444; }
        .modal { transition: opacity 0.25s ease; }
        body.modal-active { overflow: hidden; }
        
        /* Status Badges */
        .status-not-started { background-color: #f3f4f6; color: #374151; }
        .status-in-progress { background-color: #e0f2fe; color: #0284c7; }
        .status-completed { background-color: #dcfce7; color: #16a34a; }
        .status-submitted { background-color: #e0e7ff; color: #4338ca; }
        .status-na { background-color: #f9fafb; color: #9ca3af; text-decoration: line-through; }
    </style>
</head>
<body class="text-gray-800">

    <!-- Navbar -->
    <nav class="bg-white shadow-sm p-4 sticky top-0 z-30">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold text-blue-600 tracking-tight">EduTrack</h1>
            <div id="auth-section" class="flex items-center gap-3">
                <button onclick="toggleModal('login-modal', true)" id="login-btn-nav" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition hidden">
                    Login / Sign Up
                </button>
                <div id="user-info" class="hidden flex items-center gap-4">
                    <!-- Data Tools Dropdown Trigger -->
                    <div class="relative group">
                        <button class="text-sm font-medium text-gray-600 hover:text-blue-600 flex items-center gap-1">
                            Data Tools â–¾
                        </button>
                        <div class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 hidden group-hover:block border border-gray-100 z-50">
                            <button onclick="exportCSV()" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 w-full text-left">Export CSV</button>
                            <label class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 w-full text-left cursor-pointer">
                                Import CSV
                                <input type="file" id="csv-upload" class="hidden" accept=".csv" onchange="importCSV(this)">
                            </label>
                        </div>
                    </div>

                    <span id="user-email" class="text-sm font-medium hidden md:inline"></span>
                    <button id="logout-btn" class="text-sm text-red-500 hover:text-red-700">Logout</button>
                    <span id="sync-status" class="text-xs text-gray-400">Synced</span>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto p-4 mt-6" id="main-app-container">
        
        <!-- Dashboard Grid -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
            <!-- GPA Card -->
            <div class="bg-white p-6 rounded-xl shadow-sm flex flex-col justify-center relative">
                <button onclick="exportPDF()" class="absolute top-4 right-4 text-gray-400 hover:text-red-600 text-xs border border-gray-200 p-1 rounded" title="Download PDF Report">
                    PDF Report
                </button>
                <h2 class="text-gray-500 text-sm uppercase tracking-wide">Cumulative GPA</h2>
                <div class="text-4xl font-bold text-gray-900 mt-1" id="overall-gpa">0.00</div>
            </div>
            
            <!-- To-Do List -->
            <div class="bg-white p-6 rounded-xl shadow-sm col-span-2 overflow-y-auto max-h-48">
                <h2 class="text-gray-500 text-sm uppercase tracking-wide mb-2">Upcoming Deadlines</h2>
                <div id="todo-list" class="space-y-2 text-sm">
                    <!-- Injected via JS -->
                    <p class="text-gray-400">No upcoming assignments.</p>
                </div>
            </div>
        </div>

        <!-- Controls -->
        <div class="flex justify-between items-center mb-4">
            <div class="border-b border-gray-200 flex-grow overflow-x-auto">
                <nav class="-mb-px flex space-x-8" id="class-tabs">
                    <!-- Tabs injected by JS -->
                </nav>
            </div>
            <button id="add-class-btn" onclick="openClassModal()" class="ml-4 bg-gray-900 text-white px-4 py-2 rounded-lg hover:bg-gray-800 transition whitespace-nowrap">
                + Add Class
            </button>
        </div>

        <!-- Class Content Area -->
        <div id="class-content" class="min-h-[400px]">
            <div class="text-center text-gray-400 mt-20">
                <p>Select a class or add one to get started.</p>
            </div>
        </div>
    </div>

    <!-- LOGIN MODAL -->
    <div id="login-modal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50"></div>
        <div class="modal-container bg-white w-11/12 md:max-w-md mx-auto rounded-lg shadow-lg z-50 overflow-y-auto">
            <div class="modal-content py-4 text-left px-6">
                <div class="flex justify-between items-center pb-3">
                    <p class="text-2xl font-bold">Welcome Back</p>
                    <div class="modal-close cursor-pointer z-50 p-2" onclick="toggleModal('login-modal', false)">
                        <span class="text-2xl">&times;</span>
                    </div>
                </div>

                <!-- Google Login -->
                <button id="google-login-btn" class="w-full flex items-center justify-center gap-2 bg-white border border-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-50 transition mb-4">
                    <svg class="w-5 h-5" viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
                    Sign in with Google
                </button>

                <div class="relative flex py-2 items-center">
                    <div class="flex-grow border-t border-gray-300"></div>
                    <span class="flex-shrink mx-4 text-gray-400 text-sm">Or with Email</span>
                    <div class="flex-grow border-t border-gray-300"></div>
                </div>

                <!-- Email Form -->
                <form id="email-auth-form" class="space-y-4">
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Email</label>
                        <input type="email" id="auth-email" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" required>
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Password</label>
                        <input type="password" id="auth-password" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" required>
                    </div>
                    <div class="flex gap-2 pt-2">
                        <button type="button" id="signin-btn" class="w-1/2 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700">Sign In</button>
                        <button type="button" id="signup-btn" class="w-1/2 bg-gray-200 text-gray-700 py-2 rounded-lg hover:bg-gray-300">Sign Up</button>
                    </div>
                </form>
                <div id="auth-message" class="text-center text-sm mt-3 text-red-500 min-h-[20px]"></div>
            </div>
        </div>
    </div>

    <!-- ADD/EDIT CLASS MODAL -->
    <div id="class-modal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50"></div>
        <div class="modal-container bg-white w-11/12 md:max-w-md mx-auto rounded-lg shadow-lg z-50 overflow-y-auto max-h-[90vh]">
            <div class="modal-content py-4 text-left px-6">
                <div class="flex justify-between items-center pb-3">
                    <p class="text-2xl font-bold">Manage Class</p>
                    <div class="modal-close cursor-pointer z-50 p-2" onclick="closeClassModal()">
                        <span class="text-2xl">&times;</span>
                    </div>
                </div>
                <form id="class-form">
                    <input type="hidden" id="edit-class-id">
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Class Name</label>
                        <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="class-name" type="text" placeholder="e.g. Calculus I" required>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Categories & Weights (%)</label>
                        <div id="category-inputs" class="space-y-2">
                            <!-- Categories injected here -->
                        </div>
                        <button type="button" onclick="addCategoryInput()" class="text-blue-500 text-sm mt-2 hover:underline font-bold">+ Add Category</button>
                    </div>

                    <div class="flex justify-end pt-2">
                        <button type="button" onclick="deleteClass()" id="delete-class-btn" class="hidden text-red-500 mr-auto hover:text-red-700 font-bold border border-red-200 px-3 py-1 rounded">Delete Class</button>
                        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Save Class</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- ADD ASSIGNMENT MODAL -->
    <div id="assignment-modal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50"></div>
        <div class="modal-container bg-white w-11/12 md:max-w-md mx-auto rounded-lg shadow-lg z-50 overflow-y-auto max-h-[90vh]">
            <div class="modal-content py-4 text-left px-6">
                <div class="flex justify-between items-center pb-3">
                    <p class="text-2xl font-bold">Assignment</p>
                    <div class="modal-close cursor-pointer z-50 p-2" onclick="closeAssignmentModal()">
                        <span class="text-2xl">&times;</span>
                    </div>
                </div>
                <form id="assignment-form">
                    <input type="hidden" id="asg-class-id">
                    <input type="hidden" id="asg-id">
                    
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Name</label>
                        <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" id="asg-name" type="text" required>
                    </div>

                    <div class="flex gap-4 mb-4">
                        <div class="w-1/2">
                            <label class="block text-gray-700 text-sm font-bold mb-2">Category</label>
                            <select id="asg-category" class="shadow border rounded w-full py-2 px-3 text-gray-700 bg-white" required>
                                <!-- Options filled via JS -->
                            </select>
                        </div>
                        <div class="w-1/2">
                            <label class="block text-gray-700 text-sm font-bold mb-2">Status</label>
                            <select id="asg-status" class="shadow border rounded w-full py-2 px-3 text-gray-700 bg-white">
                                <option value="not-started">Not Started</option>
                                <option value="in-progress">In Progress</option>
                                <option value="completed">Completed</option>
                                <option value="submitted">Submitted</option>
                                <option value="na">N/A</option>
                            </select>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Due Date (Optional)</label>
                        <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" id="asg-date" type="date">
                    </div>

                    <div class="flex gap-4 mb-4">
                        <div class="w-1/2">
                            <label class="block text-gray-700 text-sm font-bold mb-2">Score</label>
                            <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" id="asg-score" type="number" step="0.1" placeholder="--" >
                        </div>
                        <div class="w-1/2">
                            <label class="block text-gray-700 text-sm font-bold mb-2">Total</label>
                            <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" id="asg-total" type="number" value="100" step="0.1">
                        </div>
                    </div>

                    <div class="flex justify-end pt-2">
                        <button type="button" id="delete-asg-btn" class="hidden text-red-500 mr-auto hover:text-red-700 font-bold border border-red-200 px-3 py-1 rounded" onclick="deleteAssignment()">Delete</button>
                        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Save</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // --- SUPABASE CONFIGURATION ---
        const SUPABASE_URL = 'https://njgjgpiamweujgyknqtz.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_3bRvo_Zuppdi4ICnOtfjeA_VWfp6Zyx'; 
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- STATE MANAGEMENT ---
        let state = {
            classes: [], 
            activeTab: null,
            user: null
        };

        // --- AUTHENTICATION ---
        async function checkUser() {
            const { data: { user } } = await supabaseClient.auth.getUser();
            state.user = user;
            updateAuthUI();
            if (user) {
                // If user is logged in, ONLY load from Supabase
                loadDataFromSupabase();
            } else {
                // Only load local data if NOT logged in (Guest mode)
                loadLocalData(); 
            }
        }

        function updateAuthUI() {
            const loginBtn = document.getElementById('login-btn-nav');
            const userInfo = document.getElementById('user-info');
            const userEmail = document.getElementById('user-email');

            if (state.user) {
                loginBtn.classList.add('hidden');
                userInfo.classList.remove('hidden');
                userEmail.innerText = state.user.email;
                toggleModal('login-modal', false); 
            } else {
                loginBtn.classList.remove('hidden');
                userInfo.classList.add('hidden');
            }
        }

        // GOOGLE LOGIN
        document.getElementById('google-login-btn').addEventListener('click', async () => {
            await supabaseClient.auth.signInWithOAuth({
                provider: 'google',
                options: {
                    redirectTo: window.location.href
                }
            });
        });

        // EMAIL LOGIN
        document.getElementById('signin-btn').addEventListener('click', async () => {
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            const msg = document.getElementById('auth-message');
            msg.innerText = '';
            
            const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
            if (error) {
                msg.innerText = error.message;
            } else {
                checkUser();
            }
        });

        // EMAIL SIGN UP
        document.getElementById('signup-btn').addEventListener('click', async () => {
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            const msg = document.getElementById('auth-message');
            msg.innerText = '';

            const { data, error } = await supabaseClient.auth.signUp({ email, password });
            if (error) {
                msg.innerText = error.message;
            } else {
                msg.innerText = "Sign up successful! You are logged in.";
                msg.classList.remove('text-red-500');
                msg.classList.add('text-green-500');
                setTimeout(checkUser, 1500);
            }
        });

        document.getElementById('logout-btn').addEventListener('click', async () => {
            await supabaseClient.auth.signOut();
            state.user = null;
            state.classes = [];
            state.activeTab = null;
            updateAuthUI();
            
            // Clear view
            document.getElementById('class-tabs').innerHTML = '';
            document.getElementById('class-content').innerHTML = '<div class="text-center text-gray-400 mt-20"><p>Please login to see your data.</p></div>';
            document.getElementById('overall-gpa').innerText = '0.00';
            document.getElementById('todo-list').innerHTML = '';
        });

        // --- IMPORT / EXPORT LOGIC ---

        function exportCSV() {
            if (state.classes.length === 0) return alert("No data to export.");

            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Type,ClassID,ClassName,CatID,CatName,CatWeight,AsgID,AsgName,AsgScore,AsgTotal,AsgDate,AsgStatus\n";

            state.classes.forEach(cls => {
                cls.categories.forEach(cat => {
                    csvContent += `Category,${cls.id},"${cls.name}",${cat.id},"${cat.name}",${cat.weight},,,,,,\n`;
                });
                
                cls.assignments.forEach(asg => {
                    const cat = cls.categories.find(c => c.id === asg.categoryId);
                    const catName = cat ? cat.name : "Unknown";
                    csvContent += `Assignment,${cls.id},"${cls.name}",${asg.categoryId},"${catName}",,${asg.id},"${asg.name}",${asg.score || ''},${asg.total || ''},${asg.dueDate || ''},${asg.status || ''}\n`;
                });
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "edutrack_export.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function importCSV(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                const rows = text.split('\n').slice(1);
                const newClasses = [];
                const classMap = {}; 

                rows.forEach(row => {
                    if (!row.trim()) return;
                    
                    const cols = row.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g) || [];
                    const cleanCols = cols.map(c => c.replace(/^"|"$/g, '').trim()); 

                    if (cleanCols.length < 3) return;

                    const type = cleanCols[0];
                    const classId = cleanCols[1];
                    const className = cleanCols[2];

                    if (!classMap[classId]) {
                        classMap[classId] = {
                            id: classId,
                            name: className,
                            categories: [],
                            assignments: []
                        };
                        newClasses.push(classMap[classId]);
                    }

                    if (type === 'Category') {
                        classMap[classId].categories.push({
                            id: cleanCols[3],
                            name: cleanCols[4],
                            weight: cleanCols[5]
                        });
                    } else if (type === 'Assignment') {
                        classMap[classId].assignments.push({
                            id: cleanCols[6],
                            categoryId: cleanCols[3],
                            name: cleanCols[7],
                            score: cleanCols[8],
                            total: cleanCols[9],
                            dueDate: cleanCols[10],
                            status: cleanCols[11]
                        });
                    }
                });

                if (newClasses.length > 0) {
                    if(confirm(`Found ${newClasses.length} classes. This will overwrite current data. Continue?`)) {
                        state.classes = newClasses;
                        if(state.classes.length > 0) state.activeTab = state.classes[0].id;
                        saveData();
                        render();
                        alert("Import successful!");
                    }
                } else {
                    alert("Could not parse CSV data.");
                }
                input.value = ''; 
            };
            reader.readAsText(file);
        }

        function exportPDF() {
            const element = document.getElementById('main-app-container');
            const opt = {
                margin:       0.5,
                filename:     'edutrack_report.pdf',
                image:        { type: 'jpeg', quality: 0.98 },
                html2canvas:  { scale: 2 },
                jsPDF:        { unit: 'in', format: 'letter', orientation: 'portrait' }
            };
            
            const originalShadows = document.querySelectorAll('.shadow-sm, .shadow-lg');
            originalShadows.forEach(el => el.classList.remove('shadow-sm', 'shadow-lg'));
            
            html2pdf().set(opt).from(element).save().then(() => {
                originalShadows.forEach(el => el.classList.add('shadow-sm'));
                render(); 
            });
        }

        // --- DATA PERSISTENCE ---

        async function saveData() {
            // IF LOGGED IN: Save ONLY to Supabase
            if (state.user) {
                document.getElementById('sync-status').innerText = 'Saving...';
                
                const { data: existingData } = await supabaseClient
                    .from('user_data')
                    .select('id')
                    .eq('user_id', state.user.id)
                    .single();

                const updatePayload = { data: state.classes, updated_at: new Date() };
                
                if (existingData) {
                    await supabaseClient
                        .from('user_data')
                        .update(updatePayload)
                        .eq('user_id', state.user.id);
                } else {
                    await supabaseClient
                        .from('user_data')
                        .insert([{ user_id: state.user.id, data: state.classes }]);
                }
                
                setTimeout(() => {
                    document.getElementById('sync-status').innerText = 'Saved';
                }, 1000);
            } else {
                // IF NOT LOGGED IN: Fallback to local storage (Guest Mode)
                localStorage.setItem('edutrack_data', JSON.stringify(state.classes));
            }
        }

        function loadLocalData() {
            const stored = localStorage.getItem('edutrack_data');
            if (stored) {
                state.classes = JSON.parse(stored);
                if(state.classes.length > 0 && !state.activeTab) state.activeTab = state.classes[0].id;
                render();
            }
        }

        async function loadDataFromSupabase() {
            document.getElementById('sync-status').innerText = 'Loading...';
            const { data, error } = await supabaseClient
                .from('user_data')
                .select('data')
                .eq('user_id', state.user.id)
                .single();

            if (data && data.data) {
                state.classes = data.data;
                if(state.classes.length > 0) state.activeTab = state.classes[0].id;
                render();
            } 
            // If no data in Supabase yet, we start with empty state, NOT local storage
            document.getElementById('sync-status').innerText = 'Synced';
        }

        // --- CORE LOGIC (GPA & GRADES) ---

        function calculateClassGrade(cls) {
            let totalWeightUsed = 0;
            let weightedSum = 0;

            cls.categories.forEach(cat => {
                const assignments = cls.assignments.filter(a => a.categoryId === cat.id && a.score !== null && a.score !== "");
                
                if (assignments.length > 0) {
                    let catTotalPoints = 0;
                    let catEarnedPoints = 0;

                    assignments.forEach(a => {
                        catEarnedPoints += parseFloat(a.score);
                        catTotalPoints += parseFloat(a.total);
                    });

                    if (catTotalPoints > 0) {
                        const catPercentage = (catEarnedPoints / catTotalPoints);
                        weightedSum += catPercentage * parseFloat(cat.weight);
                        totalWeightUsed += parseFloat(cat.weight);
                    }
                }
            });

            if (totalWeightUsed === 0) return null; 

            return (weightedSum / totalWeightUsed) * 100;
        }

        function getLetterGrade(percentage) {
            if (percentage === null) return 'N/A';
            if (percentage >= 90) return 'A';
            if (percentage >= 80) return 'B';
            if (percentage >= 70) return 'C';
            if (percentage >= 60) return 'D';
            return 'F';
        }

        function getGPAFromLetter(letter) {
            if (letter === 'A') return 4.0;
            if (letter === 'B') return 3.0;
            if (letter === 'C') return 2.0;
            if (letter === 'D') return 1.0;
            return 0.0;
        }

        function calculateOverallGPA() {
            let totalGPA = 0;
            let count = 0;

            state.classes.forEach(cls => {
                const grade = calculateClassGrade(cls);
                if (grade !== null) {
                    totalGPA += getGPAFromLetter(getLetterGrade(grade));
                    count++;
                }
            });

            const finalGPA = count === 0 ? 0 : (totalGPA / count);
            document.getElementById('overall-gpa').innerText = finalGPA.toFixed(2);
        }

        function getStatusLabel(status) {
            switch(status) {
                case 'in-progress': return 'In Progress';
                case 'completed': return 'Completed';
                case 'submitted': return 'Submitted';
                case 'na': return 'N/A';
                default: return 'Not Started';
            }
        }

        function renderTodoList() {
            const listEl = document.getElementById('todo-list');
            listEl.innerHTML = '';

            let allAssignments = [];
            state.classes.forEach(cls => {
                cls.assignments.forEach(asg => {
                    // Include if it's not completed/submitted/na
                    if (asg.status !== 'completed' && asg.status !== 'submitted' && asg.status !== 'na') {
                        allAssignments.push({ ...asg, className: cls.name, classId: cls.id });
                    }
                });
            });

            // Sort by date
            allAssignments.sort((a, b) => {
                if (!a.dueDate) return 1;
                if (!b.dueDate) return -1;
                return new Date(a.dueDate) - new Date(b.dueDate);
            });

            if (allAssignments.length === 0) {
                listEl.innerHTML = '<p class="text-gray-400 italic">No pending assignments.</p>';
                return;
            }

            const today = new Date();
            today.setHours(0,0,0,0);

            allAssignments.forEach(asg => {
                let timeText = asg.dueDate || 'No Date';
                let timeColor = 'bg-gray-100 text-gray-600';

                if (asg.dueDate) {
                    const dueDate = new Date(asg.dueDate);
                    dueDate.setHours(0,0,0,0);
                    
                    if (dueDate < today) {
                        timeColor = 'bg-red-100 text-red-800';
                        timeText += ' (Overdue)';
                    } else if (dueDate.getTime() === today.getTime()) {
                        timeColor = 'bg-yellow-100 text-yellow-800';
                        timeText = 'Today';
                    } else {
                        timeColor = 'bg-blue-100 text-blue-800';
                    }
                }

                const item = document.createElement('div');
                item.className = 'flex justify-between items-center bg-gray-50 p-2 rounded border border-gray-100 cursor-pointer hover:bg-gray-100';
                item.onclick = () => {
                    state.activeTab = asg.classId;
                    render(); // Switch tab
                    editAssignment(asg.id); // Open modal
                };
                item.innerHTML = `
                    <div>
                        <span class="font-medium text-gray-800">${asg.name}</span>
                        <span class="text-xs text-gray-500 block">${asg.className}</span>
                    </div>
                    <span class="text-xs font-semibold px-2 py-1 rounded ${timeColor}">${timeText}</span>
                `;
                listEl.appendChild(item);
            });
        }

        // --- UI RENDERING ---

        function render() {
            renderTodoList();
            
            const tabsContainer = document.getElementById('class-tabs');
            const contentContainer = document.getElementById('class-content');
            
            tabsContainer.innerHTML = '';
            
            if (state.classes.length === 0) {
                contentContainer.innerHTML = '<div class="text-center text-gray-400 mt-20"><p>No classes added yet.</p></div>';
                calculateOverallGPA();
                return;
            }

            state.classes.forEach(cls => {
                const isActive = cls.id === state.activeTab;
                const tabBtn = document.createElement('a');
                tabBtn.className = `cursor-pointer whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm ${isActive ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'}`;
                tabBtn.innerText = cls.name;
                tabBtn.onclick = () => { state.activeTab = cls.id; render(); };
                tabsContainer.appendChild(tabBtn);
            });

            const activeClass = state.classes.find(c => c.id === state.activeTab);
            if (activeClass) {
                const currentGrade = calculateClassGrade(activeClass);
                const letterGrade = getLetterGrade(currentGrade);
                const gradeColorClass = `grade-${letterGrade}`;

                let assignmentsHtml = '';
                
                if(!activeClass.assignments || activeClass.assignments.length === 0) {
                     assignmentsHtml = `<div class="text-center text-gray-400 py-10">No assignments yet.</div>`;
                     if(!activeClass.assignments) activeClass.assignments = [];
                } else {
                    assignmentsHtml = `<div class="bg-white shadow overflow-hidden sm:rounded-md mt-4"><ul class="divide-y divide-gray-200">`;
                    
                    // Sort by due date
                    activeClass.assignments.sort((a,b) => {
                         if (a.dueDate && b.dueDate) return new Date(b.dueDate) - new Date(a.dueDate);
                         return 0;
                    });

                    activeClass.assignments.forEach(asg => {
                        const cat = activeClass.categories.find(c => c.id === asg.categoryId);
                        const catName = cat ? cat.name : 'Unknown';
                        const scoreDisplay = (asg.score !== null && asg.score !== "") ? `${asg.score}/${asg.total}` : '-';
                        const percent = (asg.score !== null && asg.score !== "") ? Math.round((asg.score/asg.total)*100) : null;
                        
                        let percentColor = 'text-gray-500';
                        if (percent !== null) {
                            percentColor = percent >= 90 ? 'text-green-600' : percent < 60 ? 'text-red-500' : 'text-gray-500';
                        }
                        
                        // Status Badge
                        const statusKey = asg.status || 'not-started';
                        const statusBadgeHtml = `<span class="text-[10px] uppercase font-bold px-2 py-0.5 rounded status-${statusKey} mr-2">${getStatusLabel(statusKey)}</span>`;
                        
                        const dateBadge = asg.dueDate ? `<span class="ml-2 text-xs text-gray-400 border border-gray-200 rounded px-1">${asg.dueDate}</span>` : '';

                        assignmentsHtml += `
                            <li class="px-4 py-4 sm:px-6 flex justify-between items-center cursor-pointer hover:bg-gray-50 group" onclick="editAssignment('${asg.id}')">
                                <div>
                                    <div class="flex items-center mb-1">
                                        <p class="text-sm font-medium text-blue-600 truncate mr-2">${asg.name}</p>
                                        ${statusBadgeHtml}
                                    </div>
                                    <div class="flex items-center">
                                        <p class="text-xs text-gray-500">${catName}</p>
                                        ${dateBadge}
                                    </div>
                                </div>
                                <div class="flex items-center gap-4">
                                    <div class="text-right">
                                        <p class="text-sm font-bold text-gray-900">${scoreDisplay}</p>
                                        <p class="text-xs ${percentColor}">${percent !== null ? percent + '%' : 'Pending'}</p>
                                    </div>
                                    <span class="text-gray-300 text-sm group-hover:text-gray-500">Edit</span>
                                </div>
                            </li>
                        `;
                    });
                    assignmentsHtml += `</ul></div>`;
                }

                contentContainer.innerHTML = `
                    <div class="flex flex-col md:flex-row gap-6">
                        <div class="md:w-1/3 space-y-4">
                            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 relative">
                                <button onclick="openClassModal('${activeClass.id}')" class="absolute top-4 right-4 text-gray-400 hover:text-blue-600 border border-gray-200 rounded px-2 text-xs font-semibold uppercase">Edit Class</button>
                                <h3 class="text-gray-500 text-xs uppercase tracking-wide">Current Grade</h3>
                                <div class="flex items-baseline mt-2">
                                    <span class="text-5xl font-extrabold ${gradeColorClass}">${currentGrade ? currentGrade.toFixed(2) : '--'}%</span>
                                    <span class="ml-2 text-2xl font-medium text-gray-400">${letterGrade}</span>
                                </div>
                                <div class="mt-4 pt-4 border-t border-gray-100">
                                    <h4 class="text-xs font-semibold text-gray-400 mb-2">Category Breakdown</h4>
                                    <div class="space-y-2">
                                        ${activeClass.categories.map(cat => {
                                            const catAsgs = activeClass.assignments.filter(a => a.categoryId === cat.id && a.score);
                                            let earned = 0, total = 0;
                                            catAsgs.forEach(a => { earned += parseFloat(a.score); total += parseFloat(a.total); });
                                            const avg = total > 0 ? Math.round((earned/total)*100) : 0;
                                            return `
                                                <div class="flex justify-between text-sm">
                                                    <span class="text-gray-600">${cat.name} <span class="text-xs text-gray-400">(${cat.weight}%)</span></span>
                                                    <span class="font-bold ${total > 0 ? '' : 'text-gray-300'}">${total > 0 ? avg + '%' : '--'}</span>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="md:w-2/3">
                            <div class="flex justify-between items-center mb-2">
                                <h3 class="text-lg font-bold text-gray-800">Assignments</h3>
                                <button onclick="openAssignmentModal()" class="bg-blue-600 text-white text-sm px-3 py-1.5 rounded hover:bg-blue-700 shadow-sm">
                                    + Add Assignment
                                </button>
                            </div>
                            ${assignmentsHtml}
                        </div>
                    </div>
                `;
            }
            calculateOverallGPA();
        }

        // --- MODAL & FORM HANDLERS ---

        function toggleModal(modalID, forceState = null) {
            const modal = document.getElementById(modalID);
            const isHidden = modal.classList.contains('opacity-0');
            
            // If forceState is provided: true = show, false = hide
            const shouldShow = forceState !== null ? forceState : isHidden;

            if (shouldShow) {
                modal.classList.remove('opacity-0', 'pointer-events-none');
                document.body.classList.add('modal-active');
            } else {
                modal.classList.add('opacity-0', 'pointer-events-none');
                document.body.classList.remove('modal-active');
            }
        }

        function openClassModal(classId = null) {
            const form = document.getElementById('class-form');
            const deleteBtn = document.getElementById('delete-class-btn');
            const catInputs = document.getElementById('category-inputs');
            catInputs.innerHTML = ''; 

            if (classId) {
                const cls = state.classes.find(c => c.id === classId);
                document.getElementById('edit-class-id').value = cls.id;
                document.getElementById('class-name').value = cls.name;
                cls.categories.forEach(cat => addCategoryInput(cat.name, cat.weight, cat.id));
                deleteBtn.classList.remove('hidden');
            } else {
                document.getElementById('edit-class-id').value = '';
                document.getElementById('class-name').value = '';
                form.reset();
                addCategoryInput('Assignments', 100);
                deleteBtn.classList.add('hidden');
            }
            toggleModal('class-modal', true);
        }

        function closeClassModal() { toggleModal('class-modal', false); }

        function addCategoryInput(name = '', weight = '', id = null) {
            const wrapper = document.createElement('div');
            wrapper.className = 'flex gap-2 category-row items-center';
            const idVal = id ? id : 'new_' + Date.now() + Math.random();
            wrapper.innerHTML = `
                <input type="text" placeholder="Category Name" class="cat-name flex-grow shadow appearance-none border rounded py-2 px-3 text-gray-700" value="${name}" required>
                <input type="number" placeholder="%" class="cat-weight w-20 shadow appearance-none border rounded py-2 px-3 text-gray-700" value="${weight}" required>
                <input type="hidden" class="cat-id" value="${idVal}">
                <button type="button" onclick="this.closest('.category-row').remove()" class="text-red-500 hover:text-red-700 px-2 font-bold text-xl leading-none">&times;</button>
            `;
            document.getElementById('category-inputs').appendChild(wrapper);
        }

        document.getElementById('class-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const id = document.getElementById('edit-class-id').value;
            const name = document.getElementById('class-name').value;
            
            const categories = [];
            document.querySelectorAll('.category-row').forEach(row => {
                categories.push({
                    id: row.querySelector('.cat-id').value,
                    name: row.querySelector('.cat-name').value,
                    weight: row.querySelector('.cat-weight').value
                });
            });

            if (categories.length === 0) {
                alert("Please add at least one category.");
                return;
            }

            if (id) {
                const cls = state.classes.find(c => c.id === id);
                cls.name = name;
                cls.categories = categories;
            } else {
                const newClass = {
                    id: 'cls_' + Date.now(),
                    name: name,
                    categories: categories,
                    assignments: []
                };
                state.classes.push(newClass);
                state.activeTab = newClass.id;
            }
            
            saveData();
            render();
            closeClassModal();
        });

        function deleteClass() {
            if(confirm('Are you sure? This will delete all assignments for this class.')) {
                const id = document.getElementById('edit-class-id').value;
                state.classes = state.classes.filter(c => c.id !== id);
                state.activeTab = state.classes.length > 0 ? state.classes[0].id : null;
                saveData();
                render();
                closeClassModal();
            }
        }

        function openAssignmentModal() {
            if (!state.activeTab) return alert("Select a class first");
            
            const activeClass = state.classes.find(c => c.id === state.activeTab);
            const select = document.getElementById('asg-category');
            select.innerHTML = '';
            
            if (activeClass.categories.length === 0) {
                alert("This class has no categories. Please edit the class to add categories.");
                return;
            }

            activeClass.categories.forEach(cat => {
                const opt = document.createElement('option');
                opt.value = cat.id;
                opt.innerText = `${cat.name} (${cat.weight}%)`;
                select.appendChild(opt);
            });

            document.getElementById('asg-class-id').value = activeClass.id;
            document.getElementById('asg-id').value = ''; 
            document.getElementById('delete-asg-btn').classList.add('hidden');
            document.getElementById('assignment-form').reset();
            // Default status
            document.getElementById('asg-status').value = 'not-started';
            
            toggleModal('assignment-modal', true);
        }

        function editAssignment(asgId) {
            const activeClass = state.classes.find(c => c.id === state.activeTab);
            const asg = activeClass.assignments.find(a => a.id === asgId);
            
            openAssignmentModal(); 
            
            document.getElementById('asg-id').value = asg.id;
            document.getElementById('asg-name').value = asg.name;
            document.getElementById('asg-category').value = asg.categoryId;
            document.getElementById('asg-score').value = asg.score;
            document.getElementById('asg-total').value = asg.total;
            document.getElementById('asg-date').value = asg.dueDate || '';
            document.getElementById('asg-status').value = asg.status || 'not-started';
            document.getElementById('delete-asg-btn').classList.remove('hidden');
        }
        
        function deleteAssignment() {
            if(confirm('Are you sure you want to delete this assignment?')) {
                const classId = document.getElementById('asg-class-id').value;
                const asgId = document.getElementById('asg-id').value;
                const cls = state.classes.find(c => c.id === classId);
                
                cls.assignments = cls.assignments.filter(a => a.id !== asgId);
                saveData();
                render();
                closeAssignmentModal();
            }
        }

        function closeAssignmentModal() { toggleModal('assignment-modal', false); }

        document.getElementById('assignment-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const classId = document.getElementById('asg-class-id').value;
            const asgId = document.getElementById('asg-id').value;
            const name = document.getElementById('asg-name').value;
            const catId = document.getElementById('asg-category').value;
            const score = document.getElementById('asg-score').value;
            const total = document.getElementById('asg-total').value;
            const date = document.getElementById('asg-date').value;
            const status = document.getElementById('asg-status').value;

            const cls = state.classes.find(c => c.id === classId);
            
            if (asgId) {
                const asg = cls.assignments.find(a => a.id === asgId);
                asg.name = name;
                asg.categoryId = catId;
                asg.score = score;
                asg.total = total;
                asg.dueDate = date;
                asg.status = status;
            } else {
                cls.assignments.push({
                    id: 'asg_' + Date.now(),
                    categoryId: catId,
                    name: name,
                    score: score,
                    total: total,
                    dueDate: date,
                    status: status,
                    created_at: new Date().toISOString()
                });
            }

            saveData();
            render();
            closeAssignmentModal();
        });

        // Initialize App
        checkUser();

    </script>
</body>
</html>