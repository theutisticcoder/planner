<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduTrack | Assignment & Grade Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
        .tab-active { border-bottom: 2px solid #6366f1; color: #6366f1; }
        input:focus, select:focus { outline: 2px solid #6366f1; border-color: transparent; }
    </style>
</head>
<body class="min-h-screen text-slate-800">

    <!-- Auth Overlay -->
    <div id="auth-overlay" class="fixed inset-0 z-50 flex items-center justify-center bg-slate-900 bg-opacity-70 p-4">
        <div class="glass w-full max-w-md rounded-2xl p-8 shadow-2xl">
            <h1 class="mb-2 text-center text-3xl font-bold text-indigo-600">EduTrack</h1>
            <p class="mb-8 text-center text-slate-500">Sign in to sync your progress</p>
            
            <form id="auth-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-slate-700">Email</label>
                    <input type="email" id="auth-email" required class="mt-1 w-full rounded-lg border border-slate-300 p-3" placeholder="student@university.edu">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700">Password</label>
                    <input type="password" id="auth-password" required class="mt-1 w-full rounded-lg border border-slate-300 p-3" placeholder="••••••••">
                </div>
                <div class="flex flex-col gap-3 pt-4">
                    <button type="submit" id="btn-login" class="w-full rounded-lg bg-indigo-600 p-3 font-semibold text-white transition hover:bg-indigo-700">Login</button>
                    <button type="button" id="btn-signup" class="w-full rounded-lg border-2 border-indigo-600 p-3 font-semibold text-indigo-600 transition hover:bg-indigo-50">Create Account</button>
                </div>
            </form>
            <p id="auth-msg" class="mt-4 text-center text-sm font-medium"></p>
        </div>
    </div>

    <!-- Main Content -->
    <div id="app-content" class="hidden">
        <!-- Header -->
        <header class="sticky top-0 z-40 border-b bg-white shadow-sm">
            <div class="mx-auto flex max-w-7xl items-center justify-between px-4 py-4 sm:px-6">
                <div class="flex items-center gap-2">
                    <div class="flex h-10 w-10 items-center justify-center rounded-xl bg-indigo-600 text-white font-bold text-xl">E</div>
                    <span class="text-xl font-bold tracking-tight">EduTrack</span>
                </div>
                <div class="flex items-center gap-4">
                    <span id="user-display" class="hidden text-sm font-medium text-slate-500 sm:block"></span>
                    <button onclick="handleLogout()" class="rounded-lg bg-slate-100 px-4 py-2 text-sm font-semibold text-slate-700 hover:bg-slate-200">Logout</button>
                </div>
            </div>
            
            <!-- Tab Navigation -->
            <nav class="mx-auto max-w-7xl px-4 sm:px-6">
                <div class="flex gap-8 overflow-x-auto text-sm font-medium">
                    <button onclick="switchTab('dashboard')" id="tab-dashboard" class="tab-active whitespace-nowrap py-4">Dashboard</button>
                    <button onclick="switchTab('masterlist')" id="tab-masterlist" class="whitespace-nowrap py-4">Assignment Masterlist</button>
                    <button onclick="switchTab('classes')" id="tab-classes" class="whitespace-nowrap py-4">My Classes</button>
                    <button onclick="switchTab('grades')" id="tab-grades" class="whitespace-nowrap py-4">Grade Tracker</button>
                </div>
            </nav>
        </header>

        <main class="mx-auto max-w-7xl p-4 sm:p-6">
            <!-- Dashboard -->
            <section id="view-dashboard" class="tab-view space-y-6">
                <div class="grid grid-cols-1 gap-6 md:grid-cols-3">
                    <div class="rounded-2xl bg-white p-6 shadow-sm">
                        <h3 class="text-sm font-medium text-slate-500">Total Progress</h3>
                        <div class="mt-2 flex items-baseline gap-2">
                            <span id="stats-total-completion" class="text-3xl font-bold">0%</span>
                            <span class="text-xs text-slate-400">assignments done</span>
                        </div>
                    </div>
                    <div class="rounded-2xl bg-white p-6 shadow-sm">
                        <h3 class="text-sm font-medium text-slate-500">Due Soon</h3>
                        <div class="mt-2 flex items-baseline gap-2">
                            <span id="stats-due-soon" class="text-3xl font-bold text-orange-500">0</span>
                            <span class="text-xs text-slate-400">next 7 days</span>
                        </div>
                    </div>
                    <div class="rounded-2xl bg-white p-6 shadow-sm">
                        <h3 class="text-sm font-medium text-slate-500">Current GPA</h3>
                        <div class="mt-2 flex items-baseline gap-2">
                            <span id="stats-gpa" class="text-3xl font-bold text-indigo-600">0.00</span>
                            <span class="text-xs text-slate-400">cumulative</span>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 gap-6 lg:grid-cols-2">
                    <div class="rounded-2xl bg-white p-6 shadow-sm">
                        <h3 class="mb-4 font-bold text-lg">Class Breakdown</h3>
                        <div id="dashboard-class-list" class="space-y-4">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                    <div class="rounded-2xl bg-white p-6 shadow-sm">
                        <h3 class="mb-4 font-bold text-lg">Upcoming Priorities</h3>
                        <div id="dashboard-urgent-list" class="space-y-3">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>
            </section>

            <!-- Masterlist -->
            <section id="view-masterlist" class="tab-view hidden space-y-6">
                <div class="flex justify-between items-center gap-4 sm:flex-row sm:items-center">
                    <h2 class="text-2xl font-bold">Assignment Masterlist</h2>
                    <button onclick="toggleModal('assignment-modal')" class="rounded-lg bg-indigo-600 px-4 py-2 font-semibold text-white hover:bg-indigo-700">+ Add Assignment</button>
                </div>

                <div class="overflow-hidden rounded-xl bg-white shadow-sm ring-1 ring-slate-200">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-slate-50 text-slate-600 uppercase text-xs font-semibold">
                                <tr>
                                    <th class="px-6 py-4">Status</th>
                                    <th class="px-6 py-4">Due Date</th>
                                    <th class="px-6 py-4">Class</th>
                                    <th class="px-6 py-4">Assignment</th>
                                    <th class="px-6 py-4 text-right">Points</th>
                                    <th class="px-6 py-4 text-center">Action</th>
                                </tr>
                            </thead>
                            <tbody id="masterlist-body" class="divide-y divide-slate-100">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Classes -->
            <section id="view-classes" class="tab-view hidden space-y-6">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold">My Classes</h2>
                    <button onclick="toggleModal('class-modal')" class="rounded-lg bg-indigo-600 px-4 py-2 font-semibold text-white hover:bg-indigo-700">+ Add Class</button>
                </div>
                <div id="classes-grid" class="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-3">
                    <!-- Populated by JS -->
                </div>
            </section>

            <!-- Grades -->
            <section id="view-grades" class="tab-view hidden space-y-6">
                <h2 class="text-2xl font-bold">Grade Calculator & Categories</h2>
                <div id="grades-container" class="space-y-8">
                    <!-- Populated by JS: Class categories and weighting -->
                </div>
            </section>
        </main>
    </div>

    <!-- Assignment Modal -->
    <div id="assignment-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-slate-900 bg-opacity-50 p-4">
        <div class="glass w-full max-w-lg rounded-2xl p-6 shadow-xl">
            <h3 class="mb-4 text-xl font-bold">Edit Assignment</h3>
            <form id="assignment-form" class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div class="col-span-2">
                        <label class="block text-sm font-medium">Assignment Name</label>
                        <input type="text" id="as-name" required class="mt-1 w-full rounded-lg border border-slate-300 p-2">
                    </div>
                    <div>
                        <label class="block text-sm font-medium">Class</label>
                        <select id="as-class" required class="mt-1 w-full rounded-lg border border-slate-300 p-2"></select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium">Type/Category</label>
                        <select id="as-category" required class="mt-1 w-full rounded-lg border border-slate-300 p-2">
                            <option>Homework</option>
                            <option>Exam</option>
                            <option>Quiz</option>
                            <option>Project</option>
                            <option>Other</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium">Due Date</label>
                        <input type="date" id="as-date" required class="mt-1 w-full rounded-lg border border-slate-300 p-2">
                    </div>
                    <div>
                        <label class="block text-sm font-medium">Points Earned</label>
                        <input type="number" id="as-points-earned" step="0.01" class="mt-1 w-full rounded-lg border border-slate-300 p-2" placeholder="N/A">
                    </div>
                    <div>
                        <label class="block text-sm font-medium">Points Possible</label>
                        <input type="number" id="as-points-possible" step="0.01" class="mt-1 w-full rounded-lg border border-slate-300 p-2" placeholder="100">
                    </div>
                </div>
                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" onclick="toggleModal('assignment-modal')" class="px-4 py-2 text-slate-600">Cancel</button>
                    <button type="submit" id="btn-edit-assignment" class="rounded-lg bg-indigo-600 px-6 py-2 font-semibold text-white">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Class Modal -->
    <div id="class-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-slate-900 bg-opacity-50 p-4">
        <div class="glass w-full max-w-md rounded-2xl p-6 shadow-xl">
            <h3 class="mb-4 text-xl font-bold">Edit Class</h3>
            <form id="class-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium">Class Name (e.g. CS101)</label>
                    <input type="text" id="cl-name" required class="mt-1 w-full rounded-lg border border-slate-300 p-2">
                </div>
                <div>
                    <label class="block text-sm font-medium">Title/Description</label>
                    <input type="text" id="cl-title" required class="mt-1 w-full rounded-lg border border-slate-300 p-2">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium">Credits</label>
                        <input type="number" id="cl-credits" value="3" class="mt-1 w-full rounded-lg border border-slate-300 p-2">
                    </div>
                    <div>
                        <label class="block text-sm font-medium">Period</label>
                        <input type="text" id="cl-period" placeholder="P1" class="mt-1 w-full rounded-lg border border-slate-300 p-2">
                    </div>
                </div>
                <div class="grid grid-cols-1 gap-4">
                    <h3 class="text-lg font-bold mb-2">Weight Categories</h3>
                    <div id="class-weight-container">
                        <!-- Populated by JS -->
                    </div>
                    <button onclick="addCategory()" class="text-indigo-600 text-sm font-semibold">+ Add Category</button>
                </div>
                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" onclick="toggleModal('class-modal')" class="px-4 py-2 text-slate-600">Cancel</button>
                    <button type="submit" id="btn-edit-class" class="rounded-lg bg-indigo-600 px-6 py-2 font-semibold text-white">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://njgjgpiamweujgyknqtz.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_3bRvo_Zuppdi4ICnOtfjeA_VWfp6Zyx';
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // App State
        let currentUser = null;
        let classes = [];
        let assignments = [];
        let currentTab = 'dashboard';

        // Initialize App
        window.addEventListener('load', async () => {
            const { data: { user } } = await _supabase.auth.getUser();
            if (user) {
                onUserLoaded(user);
            }
        });

        // --- AUTH LOGIC ---
        const authForm = document.getElementById('auth-form');
        const authMsg = document.getElementById('auth-msg');

        document.getElementById('btn-login').onclick = async (e) => {
            e.preventDefault();
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            authMsg.innerText = "Logging in...";
            
            const { data, error } = await _supabase.auth.signInWithPassword({ email, password });
            if (error) authMsg.innerText = "Error: " + error.message;
            else onUserLoaded(data.user);
        };

        document.getElementById('btn-signup').onclick = async (e) => {
            e.preventDefault();
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            authMsg.innerText = "Creating account...";

            const { data, error } = await _supabase.auth.signUp({ email, password });
            if (error) authMsg.innerText = "Error: " + error.message;
            else authMsg.innerText = "Check your email for confirmation!";
        };

        async function onUserLoaded(user) {
            currentUser = user;
            document.getElementById('auth-overlay').classList.add('hidden');
            document.getElementById('app-content').classList.remove('hidden');
            document.getElementById('user-display').innerText = user.email;
            
            await loadData();
            renderAll();
        }

        async function handleLogout() {
            await _supabase.auth.signOut();
            window.location.reload();
        }

        // --- DATA LOGIC ---
        async function loadData() {
            // In a real production app, you'd create these tables in Supabase:
            // tables: classes (id, user_id, name, title, credits, period, weights: jsonb)
            // tables: assignments (id, user_id, class_id, name, category, due_date, points_earned, points_possible, completed)
            
            // For this environment, we simulate table storage via Supabase 'users' metadata or private data buckets if available.
            // Since we can't create tables dynamically via browser JS, we'll use a single JSON object in user metadata for persistence
            // or local storage as fallback if metadata write fails.
            
            const { data: { user } } = await _supabase.auth.getUser();
            if (user?.user_metadata?.edu_data) {
                const stored = user.user_metadata.edu_data;
                classes = stored.classes || [];
                assignments = stored.assignments || [];
            } else {
                // Initialize defaults
                classes = [
                    { id: '1', name: 'CS101', title: 'Intro to Programming', credits: 4, period: 'P1', weights: { 'Homework': 20, 'Exam': 50, 'Project': 30 } },
                    { id: '2', name: 'ENG202', title: 'British Literature', credits: 3, period: 'P2', weights: { 'Homework': 50, 'Exam': 50 } }
                ];
                assignments = [];
            }
        }

        async function saveData() {
            if (!currentUser) return;
            const edu_data = { classes, assignments };
            await _supabase.auth.updateUser({
                data: { edu_data }
            });
        }

        // --- UI LOGIC ---
        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab-view').forEach(el => el.classList.add('hidden'));
            document.getElementById(`view-${tab}`).classList.remove('hidden');
            
            document.querySelectorAll('nav button').forEach(el => el.classList.remove('tab-active'));
            document.getElementById(`tab-${tab}`).classList.add('tab-active');
            
            renderAll();
        }

        function toggleModal(id, editId = null) {
            const modal = document.getElementById(id);
            modal.classList.toggle('hidden');
            
            if (id === 'assignment-modal' && editId) {
                const as = assignments.find(a => a.id === editId);
                if (as) {
                    document.getElementById('as-name').value = as.name;
                    document.getElementById('as-class').value = as.class_id;
                    document.getElementById('as-category').value = as.category;
                    document.getElementById('as-date').value = as.due_date;
                    document.getElementById('as-points-earned').value = as.points_earned || '';
                    document.getElementById('as-points-possible').value = as.points_possible;
                }
            }
            
            if (id === 'class-modal' && editId) {
                const cls = classes.find(c => c.id === editId);
                if (cls) {
                    document.getElementById('cl-name').value = cls.name;
                    document.getElementById('cl-title').value = cls.title;
                    document.getElementById('cl-credits').value = cls.credits;
                    document.getElementById('cl-period').value = cls.period;
                    
                    // Clear existing weight categories
                    const container = document.getElementById('class-weight-container');
                    container.innerHTML = '';
                    
                    // Populate with existing weights
                    Object.entries(cls.weights || {}).forEach(([cat, val]) => {
                        container.innerHTML += `
                            <div class="flex items-center gap-2 mb-2">
                                <span class="text-sm font-medium w-24">${cat}:</span>
                                <input type="number" value="${val}" onchange="updateWeight('${cls.id}', '${cat}', this.value)" class="w-16 rounded border p-1 text-sm">
                                <span class="text-slate-400">%</span>
                            </div>
                        `;
                    });
                }
            }
        }

        // --- CALCULATIONS ---
        function calculateGrade(classId) {
            const classObj = classes.find(c => c.id === classId);
            if (!classObj) return 0;
            
            const classAssignments = assignments.filter(a => a.class_id === classId && a.points_possible > 0 && a.points_earned !== null);
            if (classAssignments.length === 0) return 100;

            const categories = classObj.weights || {};
            let totalWeightedGrade = 0;
            let totalWeightUsed = 0;

            for (const [cat, weight] of Object.entries(categories)) {
                const catAssignments = classAssignments.filter(a => a.category === cat);
                if (catAssignments.length > 0) {
                    const earned = catAssignments.reduce((sum, a) => sum + parseFloat(a.points_earned || 0), 0);
                    const possible = catAssignments.reduce((sum, a) => sum + parseFloat(a.points_possible), 0);
                    totalWeightedGrade += (earned / possible) * weight;
                    totalWeightUsed += weight;
                }
            }

            return totalWeightUsed > 0 ? (totalWeightedGrade / totalWeightUsed) * 100 : 100;
        }

        function getGPAPoints(percent) {
            if (percent >= 93) return 4.0;
            if (percent >= 90) return 3.7;
            if (percent >= 87) return 3.3;
            if (percent >= 83) return 3.0;
            if (percent >= 80) return 2.7;
            if (percent >= 77) return 2.3;
            if (percent >= 73) return 2.0;
            if (percent >= 70) return 1.7;
            if (percent >= 60) return 1.0;
            return 0.0;
        }

        function calculateCumulativeGPA() {
            let totalPoints = 0;
            let totalCredits = 0;
            classes.forEach(c => {
                const grade = calculateGrade(c.id);
                const points = getGPAPoints(grade);
                totalPoints += points * (c.credits || 0);
                totalCredits += (c.credits || 0);
            });
            return totalCredits > 0 ? (totalPoints / totalCredits).toFixed(2) : "0.00";
        }

        // --- RENDERING ---
        function renderAll() {
            if (currentTab === 'dashboard') renderDashboard();
            if (currentTab === 'masterlist') renderMasterlist();
            if (currentTab === 'classes') renderClasses();
            if (currentTab === 'grades') renderGrades();
            updateStats();
        }

        function updateStats() {
            const completed = assignments.filter(a => a.completed).length;
            const total = assignments.length;
            const completion = total > 0 ? Math.round((completed / total) * 100) : 0;
            document.getElementById('stats-total-completion').innerText = `${completion}%`;

            const now = new Date();
            const weekLater = new Date();
            weekLater.setDate(now.getDate() + 7);
            const dueSoon = assignments.filter(a => !a.completed && new Date(a.due_date) <= weekLater).length;
            document.getElementById('stats-due-soon').innerText = dueSoon;

            document.getElementById('stats-gpa').innerText = calculateCumulativeGPA();
        }

        function renderDashboard() {
            const classList = document.getElementById('dashboard-class-list');
            classList.innerHTML = classes.map(c => {
                const grade = calculateGrade(c.id).toFixed(1);
                const color = grade >= 90 ? 'text-green-600' : grade >= 80 ? 'text-blue-600' : 'text-orange-600';
                return `
                    <div class="flex items-center justify-between border-b pb-2">
                        <div>
                            <p class="font-bold">${c.name}</p>
                            <p class="text-xs text-slate-400">${c.title}</p>
                        </div>
                        <span class="text-xl font-bold ${color}">${grade}%</span>
                    </div>
                `;
            }).join('');

            const urgentList = document.getElementById('dashboard-urgent-list');
            const pending = assignments.filter(a => !a.completed).sort((a,b) => new Date(a.due_date) - new Date(b.due_date)).slice(0, 5);
            urgentList.innerHTML = pending.length ? pending.map(a => `
                <div class="flex items-center gap-3 rounded-lg border p-3 hover:bg-slate-50">
                    <div class="h-2 w-2 rounded-full bg-indigo-500"></div>
                    <div class="flex-1">
                        <p class="text-sm font-semibold">${a.name}</p>
                        <p class="text-xs text-slate-500">${classes.find(c => c.id === a.class_id)?.name} • Due ${a.due_date}</p>
                    </div>
                    <button onclick="toggleComplete('${a.id}')" class="text-xs font-bold text-indigo-600 uppercase">Check</button>
                </div>
            `).join('') : '<p class="text-slate-400 text-sm italic">All caught up!</p>';
        }

        function renderMasterlist() {
            const body = document.getElementById('masterlist-body');
            body.innerHTML = assignments.sort((a,b) => new Date(a.due_date) - new Date(b.due_date)).map(a => {
                const cls = classes.find(c => c.id === a.class_id);
                return `
                    <tr class="hover:bg-slate-50 transition">
                        <td class="px-6 py-4">
                            <input type="checkbox" ${a.completed ? 'checked' : ''} onchange="toggleComplete('${a.id}')" class="h-5 w-5 rounded border-slate-300 text-indigo-600">
                        </td>
                        <td class="px-6 py-4 font-medium">${a.due_date}</td>
                        <td class="px-6 py-4 text-slate-500">${cls?.name || 'Unknown'}</td>
                        <td class="px-6 py-4">
                            <div class="font-semibold">${a.name}</div>
                            <div class="text-xs text-slate-400">${a.category}</div>
                        </td>
                        <td class="px-6 py-4 text-right tabular-nums">
                            ${a.points_earned !== null ? `${a.points_earned} / ${a.points_possible}` : `-- / ${a.points_possible}`}
                        </td>
                        <td class="px-6 py-4 text-center">
                            <button onclick="deleteAssignment('${a.id}')" class="text-slate-300 hover:text-red-500">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function renderClasses() {
            const grid = document.getElementById('classes-grid');
            grid.innerHTML = classes.map(c => `
                <div class="rounded-2xl bg-white p-6 shadow-sm ring-1 ring-slate-200">
                    <div class="mb-4 flex items-center justify-between">
                        <span class="rounded bg-indigo-100 px-2 py-1 text-xs font-bold">${c.period}</span>
                        <button onclick="toggleModal('class-modal', '${c.id}')" class="text-slate-300 hover:text-red-500">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </div>
                    <h3 class="text-xl font-bold">${c.name}</h3>
                    <p class="text-slate-500 text-sm">${c.title}</p>
                    <div class="mt-4 flex items-center justify-between text-sm">
                        <span class="text-slate-400">Credits: ${c.credits}</span>
                        <span class="font-bold text-indigo-600">${calculateGrade(c.id).toFixed(1)}%</span>
                    </div>
                </div>
            `).join('');
        }

        function renderGrades() {
            const container = document.getElementById('grades-container');
            container.innerHTML = classes.map(c => {
                const catHtml = Object.entries(c.weights || {}).map(([cat, val]) => `
                    <div class="flex items-center gap-2 mb-2">
                        <span class="text-sm font-medium w-24">${cat}:</span>
                        <input type="number" value="${val}" onchange="updateWeight('${c.id}', '${cat}', this.value)" class="w-16 rounded border p-1 text-sm">
                        <span class="text-slate-400">%</span>
                    </div>
                `).join('');

                return `
                    <div class="rounded-2xl bg-white p-6 shadow-sm border border-slate-100">
                        <div class="flex justify-between mb-4">
                            <h3 class="text-lg font-bold">${c.name} - Weighted Categories</h3>
                            <button onclick="addCategory('${c.id}')" class="text-indigo-600 text-sm font-semibold">+ Add Category</button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>${catHtml}</div>
                            <div class="bg-slate-50 rounded-lg p-4 text-sm text-slate-600">
                                <p class="font-semibold mb-2">Weighting Instructions:</p>
                                <p>Ensure percentages add up to 100%. If they don't, the system will scale them proportionally based on what has been entered.</p>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // --- HANDLERS ---
        document.getElementById('assignment-form').onsubmit = async (e) => {
            e.preventDefault();
            const newAs = {
                id: Date.now().toString(),
                name: document.getElementById('as-name').value,
                class_id: document.getElementById('as-class').value,
                category: document.getElementById('as-category').value,
                due_date: document.getElementById('as-date').value,
                points_earned: document.getElementById('as-points-earned').value ? parseFloat(document.getElementById('as-points-earned').value) : null,
                points_possible: parseFloat(document.getElementById('as-points-possible').value) || 100,
                completed: false
            };
            assignments.push(newAs);
            await saveData();
            toggleModal('assignment-modal');
            renderAll();
            e.target.reset();
        };

        document.getElementById('class-form').onsubmit = async (e) => {
            e.preventDefault();
            const newCl = {
                id: Date.now().toString(),
                name: document.getElementById('cl-name').value,
                title: document.getElementById('cl-title').value,
                credits: parseInt(document.getElementById('cl-credits').value) || 3,
                period: document.getElementById('cl-period').value,
                weights: { 'Homework': 50, 'Exam': 50 }
            };
            classes.push(newCl);
            await saveData();
            toggleModal('class-modal');
            renderAll();
            e.target.reset();
        };

        async function toggleComplete(id) {
            const as = assignments.find(a => a.id === id);
            if (as) as.completed = !as.completed;
            await saveData();
            renderAll();
        }

        async function deleteAssignment(id) {
            assignments = assignments.filter(a => a.id !== id);
            await saveData();
            renderAll();
        }

        async function deleteClass(id) {
            if (confirm("Delete this class? All linked assignments will remain but lose their class connection.")) {
                classes = classes.filter(c => c.id !== id);
                await saveData();
                renderAll();
            }
        }

        async function updateWeight(classId, category, val) {
            const cls = classes.find(c => c.id === classId);
            if (cls) {
                cls.weights[category] = parseFloat(val);
                await saveData();
                renderAll();
            }
        }

        async function addCategory(classId) {
            const cat = prompt("Enter new category name (e.g., Participation):");
            if (cat) {
                const cls = classes.find(c => c.id === classId);
                if (cls) {
                    cls.weights[cat] = 0;
                    await saveData();
                    renderAll();
                }
            }
        }
    </script>
</body>
</html>
