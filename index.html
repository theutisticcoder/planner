<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduTrack Pro - Cloud Sync</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .glass-card { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(8px); border: 1px solid rgba(226, 232, 240, 0.8); }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        #auth-overlay { background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(12px); display: none; }
    </style>
</head>
<body class="bg-[#f0f2f5] text-slate-900 min-h-screen">

    <!-- Auth Overlay -->
    <div id="auth-overlay" class="fixed inset-0 z-[100] flex items-center justify-center p-6">
        <div class="bg-white w-full max-w-md rounded-[2.5rem] p-10 shadow-2xl">
            <div class="text-center mb-8">
                <div class="bg-indigo-600 w-16 h-16 rounded-2xl flex items-center justify-center text-white mx-auto mb-4 shadow-lg">
                    <svg width="32" height="32" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M22 10v6M2 10l10-5 10 5-10 5z"/><path d="M6 12v5c3 3 9 3 12 0v-5"/></svg>
                </div>
                <h2 class="text-3xl font-extrabold">Welcome Back</h2>
                <p class="text-slate-500 mt-2">Sign in to sync your academic data</p>
            </div>
            <div class="space-y-4">
                <input id="auth-email" type="email" placeholder="University Email" class="w-full px-6 py-4 rounded-2xl bg-slate-50 border border-slate-100 outline-none focus:ring-2 ring-indigo-500/20 font-medium">
                <input id="auth-password" type="password" placeholder="Password" class="w-full px-6 py-4 rounded-2xl bg-slate-50 border border-slate-100 outline-none focus:ring-2 ring-indigo-500/20 font-medium">
                <button id="btn-login" class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-bold text-lg hover:bg-indigo-700 transition-all shadow-lg shadow-indigo-100">Sign In / Sign Up</button>
            </div>
            <div id="auth-error" class="mt-4 text-center text-red-500 text-xs font-bold hidden"></div>
        </div>
    </div>

    <!-- Main UI -->
    <div class="flex flex-col md:flex-row min-h-screen">
        <!-- Sidebar -->
        <aside class="w-full md:w-80 bg-white border-r border-slate-200 flex flex-col p-6 sticky top-0 h-auto md:h-screen z-30">
            <div class="flex items-center justify-between mb-10 px-2">
                <div class="flex items-center gap-3">
                    <div class="bg-indigo-600 p-2.5 rounded-2xl text-white">
                        <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M22 10v6M2 10l10-5 10 5-10 5z"/><path d="M6 12v5c3 3 9 3 12 0v-5"/></svg>
                    </div>
                    <h1 class="font-extrabold text-2xl tracking-tight">EduTrack</h1>
                </div>
                <div id="sync-indicator" class="w-2 h-2 rounded-full bg-emerald-500"></div>
            </div>

            <nav class="space-y-2 flex-1">
                <button onclick="switchTab('dashboard')" id="nav-dashboard" class="nav-btn w-full flex items-center gap-4 px-5 py-4 rounded-2xl transition-all font-bold text-slate-500 hover:bg-slate-50">Dashboard</button>
                <button onclick="switchTab('semester')" id="nav-semester" class="nav-btn w-full flex items-center gap-4 px-5 py-4 rounded-2xl transition-all font-bold text-slate-500 hover:bg-slate-50">Semester Manager</button>
                <button onclick="switchTab('grades')" id="nav-grades" class="nav-btn w-full flex items-center gap-4 px-5 py-4 rounded-2xl transition-all font-bold text-slate-500 hover:bg-slate-50">Grade Tracker</button>
            </nav>

            <div class="mt-auto space-y-3 pt-6 border-t">
                <div id="user-display" class="px-4 py-2 text-[10px] font-black text-slate-400 truncate uppercase">Not Logged In</div>
                <button onclick="exportFullReport()" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-bold hover:bg-black transition-all">Download Report</button>
                <button onclick="logout()" class="w-full text-slate-400 py-2 rounded-2xl font-bold text-xs hover:text-red-500">Logout</button>
            </div>
        </aside>

        <!-- Workspace -->
        <main class="flex-1 p-6 md:p-10 lg:p-16 overflow-y-auto">
            <div id="tab-dashboard" class="tab-content space-y-10">
                <header class="flex justify-between items-center">
                    <div>
                        <h2 class="text-4xl font-extrabold">Academic Overview</h2>
                        <p id="welcome-text" class="text-slate-500 font-medium mt-1">Ready for the semester?</p>
                    </div>
                    <div class="glass-card px-8 py-6 rounded-[2rem] text-center">
                        <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Cumulative GPA</p>
                        <span id="cum-gpa" class="text-4xl font-black text-indigo-600">0.00</span>
                    </div>
                </header>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8" id="semester-summary-grid"></div>
            </div>

            <div id="tab-semester" class="tab-content space-y-8">
                <div class="flex justify-between items-center">
                    <h2 class="text-3xl font-extrabold">Semester Manager</h2>
                    <button onclick="addSemester()" class="bg-indigo-600 text-white px-6 py-3 rounded-2xl font-bold">+ New Semester</button>
                </div>
                <div id="semester-list" class="space-y-10"></div>
            </div>

            <div id="tab-grades" class="tab-content space-y-8">
                <h2 class="text-3xl font-extrabold">Grade Distribution</h2>
                <div id="grade-config-container" class="space-y-12"></div>
            </div>
        </main>
    </div>

    <script>
        // --- SUPABASE CONFIG ---
        const SB_URL = 'https://njgjgpiamweujgyknqtz.supabase.co';
        const SB_KEY = 'sb_publishable_3bRvo_Zuppdi4ICnOtfjeA_VWfp6Zyx';
        const supabase = window.supabase.createClient(SB_URL, SB_KEY);

        let currentUser = null;
        let appState = {
            semesters: [],
            assignments: []
        };

        // --- AUTH LOGIC ---
        async function checkSession() {
            const { data: { user } } = await supabase.auth.getUser();
            if (user) {
                currentUser = user;
                document.getElementById('auth-overlay').style.display = 'none';
                document.getElementById('user-display').innerText = user.email;
                await loadCloudData();
            } else {
                document.getElementById('auth-overlay').style.display = 'flex';
            }
        }

        document.getElementById('btn-login').onclick = async () => {
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            const errorEl = document.getElementById('auth-error');

            const { data, error } = await supabase.auth.signInWithPassword({ email, password });
            
            if (error) {
                // Try signup if login fails
                const { error: signUpError } = await supabase.auth.signUp({ email, password });
                if (signUpError) {
                    errorEl.innerText = signUpError.message;
                    errorEl.classList.remove('hidden');
                } else {
                    errorEl.innerText = "Verification email sent!";
                    errorEl.classList.remove('hidden');
                    errorEl.classList.replace('text-red-500', 'text-emerald-500');
                }
            } else {
                window.location.reload();
            }
        };

        async function logout() {
            await supabase.auth.signOut();
            window.location.reload();
        }

        // --- DATA SYNC ---
        async function loadCloudData() {
            const { data, error } = await supabase
                .from('user_data')
                .select('payload')
                .eq('id', currentUser.id)
                .single();

            if (data) {
                appState = data.payload;
            } else {
                // Initial Seed if new user
                appState = { semesters: [{ id: '1', name: 'Fall 2024', courses: [] }], assignments: [] };
            }
            render();
        }

        async function pushCloudData() {
            if (!currentUser) return;
            document.getElementById('sync-indicator').classList.replace('bg-emerald-500', 'bg-amber-500');
            
            const { error } = await supabase
                .from('user_data')
                .upsert({ id: currentUser.id, payload: appState, updated_at: new Date() });

            setTimeout(() => {
                document.getElementById('sync-indicator').classList.replace('bg-amber-500', 'bg-emerald-500');
            }, 800);
            render();
        }

        // --- CORE LOGIC ---
        function addSemester() {
            appState.semesters.push({ id: Date.now().toString(), name: 'New Semester', courses: [] });
            pushCloudData();
        }

        function addCourse(semId) {
            const sem = appState.semesters.find(s => s.id === semId);
            sem.courses.push({
                id: 'c-' + Date.now(),
                name: 'New Class',
                credits: 3,
                color: '#6366f1',
                weights: [{ name: 'Homework', percent: 20 }, { name: 'Exams', percent: 80 }]
            });
            pushCloudData();
        }

        function calculateCourseGrade(course) {
            const courseTasks = appState.assignments.filter(a => a.courseId === course.id);
            if (!courseTasks.length) return 0;
            let totalWeighted = 0;
            let totalWeightsAvailable = 0;
            course.weights.forEach(cat => {
                const catTasks = courseTasks.filter(a => a.category === cat.name);
                if (catTasks.length) {
                    const avg = catTasks.reduce((s, t) => s + (t.score / t.total), 0) / catTasks.length;
                    totalWeighted += avg * cat.percent;
                    totalWeightsAvailable += cat.percent;
                }
            });
            return totalWeightsAvailable > 0 ? (totalWeighted / totalWeightsAvailable) * 100 : 0;
        }

        function calculateGPA(semId) {
            const sem = appState.semesters.find(s => s.id === semId);
            if (!sem || !sem.courses.length) return "0.00";
            let pts = 0, crd = 0;
            sem.courses.forEach(c => {
                const g = calculateCourseGrade(c);
                pts += (g >= 90 ? 4 : g >= 80 ? 3 : g >= 70 ? 2 : g >= 60 ? 1 : 0) * c.credits;
                crd += c.credits;
            });
            return crd > 0 ? (pts / crd).toFixed(2) : "0.00";
        }

        // --- RENDERING ---
        function render() {
            renderDashboard();
            renderSemesters();
            renderGradeTracker();
        }

        function renderDashboard() {
            const grid = document.getElementById('semester-summary-grid');
            grid.innerHTML = appState.semesters.map(s => `
                <div class="glass-card p-8 rounded-[2.5rem] flex justify-between items-center shadow-sm">
                    <div><h3 class="text-xl font-bold">${s.name}</h3><p class="text-xs text-slate-400">${s.courses.length} Courses</p></div>
                    <div class="text-right"><p class="text-[10px] font-black text-slate-400 uppercase">GPA</p><p class="text-3xl font-black text-indigo-600">${calculateGPA(s.id)}</p></div>
                </div>
            `).join('');
            
            const totalGPA = appState.semesters.reduce((a, s) => a + parseFloat(calculateGPA(s.id)), 0);
            document.getElementById('cum-gpa').innerText = appState.semesters.length ? (totalGPA / appState.semesters.length).toFixed(2) : "0.00";
        }

        function renderSemesters() {
            const container = document.getElementById('semester-list');
            container.innerHTML = appState.semesters.map(s => `
                <div class="space-y-4">
                    <div class="bg-white p-6 rounded-[2rem] border border-slate-100 flex items-center gap-4">
                        <input value="${s.name}" onchange="updateSemName('${s.id}', this.value)" class="text-xl font-bold flex-1 bg-transparent border-none outline-none">
                        <div class="text-right px-6 border-x"><p class="text-[10px] font-bold text-slate-400 uppercase">Sem GPA</p><p class="text-lg font-black text-indigo-600">${calculateGPA(s.id)}</p></div>
                        <button onclick="deleteSem('${s.id}')" class="text-slate-300 hover:text-red-500"><svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg></button>
                    </div>
                    <div class="flex flex-wrap gap-4">
                        ${s.courses.map(c => `
                            <div class="bg-white px-6 py-4 rounded-2xl border flex items-center gap-4">
                                <div class="w-3 h-3 rounded-full" style="background-color: ${c.color}"></div>
                                <input value="${c.name}" onchange="updateCourse('${c.id}', 'name', this.value)" class="font-bold text-sm bg-transparent outline-none w-24">
                                <button onclick="deleteCourse('${s.id}', '${c.id}')" class="text-slate-200 hover:text-red-500"><svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg></button>
                            </div>
                        `).join('')}
                        <button onclick="addCourse('${s.id}')" class="px-6 py-4 rounded-2xl border-2 border-dashed border-slate-200 text-slate-400 font-bold hover:border-indigo-300">+ Add Class</button>
                    </div>
                </div>
            `).join('');
        }

        function renderGradeTracker() {
            const container = document.getElementById('grade-config-container');
            const courses = appState.semesters.flatMap(s => s.courses);
            container.innerHTML = courses.map(c => `
                <div class="bg-white rounded-[2.5rem] border border-slate-100 shadow-sm overflow-hidden">
                    <div class="p-8 bg-slate-50/50 border-b flex justify-between items-center">
                        <div><h3 class="text-2xl font-extrabold">${c.name}</h3><p class="text-xs font-bold text-indigo-600 uppercase">Grade: ${calculateCourseGrade(c).toFixed(1)}%</p></div>
                        <button onclick="addTask('${c.id}')" class="bg-indigo-600 text-white px-5 py-2 rounded-xl text-sm font-bold">New Task</button>
                    </div>
                    <div class="p-8 grid grid-cols-1 md:grid-cols-4 gap-8">
                        <div class="space-y-3">
                            <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Syllabus Weights</p>
                            ${c.weights.map((w, i) => `
                                <div class="flex gap-2">
                                    <input value="${w.name}" onchange="updateWeight('${c.id}', ${i}, 'name', this.value)" class="flex-1 text-xs font-bold p-2 bg-slate-50 rounded-lg outline-none">
                                    <input value="${w.percent}" onchange="updateWeight('${c.id}', ${i}, 'percent', this.value)" class="w-10 text-xs font-bold p-2 bg-slate-50 rounded-lg outline-none">%
                                </div>
                            `).join('')}
                        </div>
                        <div class="md:col-span-3">
                            <table class="w-full text-left">
                                <thead class="text-[10px] font-black text-slate-400 uppercase"><tr><th class="pb-3">Task</th><th class="pb-3">Category</th><th class="pb-3">Score</th><th class="pb-3">Total</th><th></th></tr></thead>
                                <tbody>
                                    ${appState.assignments.filter(a => a.courseId === c.id).map(a => `
                                        <tr class="border-t border-slate-50">
                                            <td><input value="${a.title}" onchange="updateTask('${a.id}', 'title', this.value)" class="text-sm bg-transparent outline-none"></td>
                                            <td><select onchange="updateTask('${a.id}', 'category', this.value)" class="text-[10px] font-bold bg-slate-50 p-1 rounded">${c.weights.map(w => `<option ${a.category === w.name ? 'selected' : ''}>${w.name}</option>`).join('')}</select></td>
                                            <td><input type="number" value="${a.score}" onchange="updateTask('${a.id}', 'score', parseFloat(this.value))" class="w-10 text-xs font-bold bg-slate-100 p-1 rounded"></td>
                                            <td><input type="number" value="${a.total}" onchange="updateTask('${a.id}', 'total', parseFloat(this.value))" class="w-10 text-xs font-bold bg-slate-100 p-1 rounded"></td>
                                            <td class="text-right"><button onclick="deleteTask('${a.id}')" class="text-slate-200 hover:text-red-500"><svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg></button></td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // --- HELPER WRAPPERS ---
        window.updateSemName = (id, val) => { appState.semesters.find(s => s.id === id).name = val; pushCloudData(); };
        window.deleteSem = (id) => { appState.semesters = appState.semesters.filter(s => s.id !== id); pushCloudData(); };
        window.updateCourse = (id, field, val) => { appState.semesters.forEach(s => s.courses.forEach(c => { if(c.id === id) c[field] = val; })); pushCloudData(); };
        window.deleteCourse = (sid, cid) => { appState.semesters.find(s => s.id === sid).courses = appState.semesters.find(s => s.id === sid).courses.filter(c => c.id !== cid); pushCloudData(); };
        window.updateWeight = (cid, idx, field, val) => { appState.semesters.forEach(s => s.courses.forEach(c => { if(c.id === cid) c.weights[idx][field] = field === 'percent' ? parseInt(val) : val; })); pushCloudData(); };
        window.addTask = (cid) => { const c = appState.semesters.flatMap(s => s.courses).find(x => x.id === cid); appState.assignments.push({ id: Date.now().toString(), courseId: cid, title: 'New Task', category: c.weights[0].name, score: 0, total: 100 }); pushCloudData(); };
        window.updateTask = (id, field, val) => { appState.assignments.find(a => a.id === id)[field] = val; pushCloudData(); };
        window.deleteTask = (id) => { appState.assignments = appState.assignments.filter(a => a.id !== id); pushCloudData(); };

        window.switchTab = (id) => {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.getElementById('tab-'+id).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(b => {
                b.classList.remove('bg-indigo-600', 'text-white', 'shadow-lg');
                b.classList.add('text-slate-500');
            });
            document.getElementById('nav-'+id).classList.add('bg-indigo-600', 'text-white', 'shadow-lg');
            document.getElementById('nav-'+id).classList.remove('text-slate-500');
        };

        async function exportFullReport() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.text("Cloud Academic Transcript", 14, 20);
            doc.save("EduTrack_Cloud_Export.pdf");
        }

        window.onload = () => {
            checkSession();
            switchTab('dashboard');
        };
    </script>
</body>
</html>

