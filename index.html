<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduTrack - Smart Assignment Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .tab-active { border-bottom: 2px solid #2563eb; color: #2563eb; font-weight: 600; }
        .tab-inactive { color: #6b7280; }
        .grade-A { color: #16a34a; }
        .grade-B { color: #84cc16; }
        .grade-C { color: #eab308; }
        .grade-D { color: #f97316; }
        .grade-F { color: #ef4444; }
        .modal { transition: opacity 0.25s ease; }
        body.modal-active { overflow: hidden; }
        /* Badge for due dates */
        .badge-upcoming { background-color: #e0f2fe; color: #0369a1; }
        .badge-overdue { background-color: #fee2e2; color: #b91c1c; }
        .badge-done { background-color: #dcfce7; color: #15803d; }
    </style>
</head>
<body class="text-gray-800">

    <!-- Navbar -->
    <nav class="bg-white shadow-sm p-4 sticky top-0 z-30">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold text-blue-600 tracking-tight">EduTrack</h1>
            <div id="auth-section" class="flex items-center gap-3">
                <button id="login-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition hidden">
                    Login with Google
                </button>
                <div id="user-info" class="hidden flex items-center gap-4">
                    <button onclick="generateShareLink()" class="text-blue-600 hover:text-blue-800 font-medium text-sm border border-blue-200 px-3 py-1 rounded">
                        <span id="share-btn-text">Share Results</span>
                    </button>
                    <span id="user-email" class="text-sm font-medium hidden md:inline"></span>
                    <button id="logout-btn" class="text-sm text-red-500 hover:text-red-700">Logout</button>
                    <span id="sync-status" class="text-xs text-gray-400">Synced</span>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto p-4 mt-6">
        
        <!-- Public View Banner (Hidden by default) -->
        <div id="public-banner" class="hidden bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6">
            <div class="flex">
                <div class="ml-3">
                    <p class="text-sm text-yellow-700">
                        You are viewing a shared grade report. This is read-only.
                        <a href="/" class="font-bold underline">Go to Home</a>
                    </p>
                </div>
            </div>
        </div>

        <!-- Dashboard Grid -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
            <!-- GPA Card -->
            <div class="bg-white p-6 rounded-xl shadow-sm flex flex-col justify-center">
                <h2 class="text-gray-500 text-sm uppercase tracking-wide">Cumulative GPA</h2>
                <div class="text-4xl font-bold text-gray-900 mt-1" id="overall-gpa">0.00</div>
            </div>
            
            <!-- To-Do List (New) -->
            <div class="bg-white p-6 rounded-xl shadow-sm col-span-2 overflow-y-auto max-h-48">
                <h2 class="text-gray-500 text-sm uppercase tracking-wide mb-2">Upcoming Deadlines</h2>
                <div id="todo-list" class="space-y-2 text-sm">
                    <!-- Injected via JS -->
                    <p class="text-gray-400">No upcoming assignments.</p>
                </div>
            </div>
        </div>

        <!-- Controls -->
        <div class="flex justify-between items-center mb-4">
            <div class="border-b border-gray-200 flex-grow overflow-x-auto">
                <nav class="-mb-px flex space-x-8" id="class-tabs">
                    <!-- Tabs injected by JS -->
                </nav>
            </div>
            <button id="add-class-btn" onclick="openClassModal()" class="ml-4 bg-gray-900 text-white px-4 py-2 rounded-lg hover:bg-gray-800 transition whitespace-nowrap">
                + Add Class
            </button>
        </div>

        <!-- Class Content Area -->
        <div id="class-content" class="min-h-[400px]">
            <div class="text-center text-gray-400 mt-20">
                <p>Select a class or add one to get started.</p>
            </div>
        </div>
    </div>

    <!-- ADD/EDIT CLASS MODAL -->
    <div id="class-modal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50"></div>
        <div class="modal-container bg-white w-11/12 md:max-w-md mx-auto rounded-lg shadow-lg z-50 overflow-y-auto max-h-[90vh]">
            <div class="modal-content py-4 text-left px-6">
                <div class="flex justify-between items-center pb-3">
                    <p class="text-2xl font-bold">Manage Class</p>
                    <div class="modal-close cursor-pointer z-50 p-2" onclick="closeClassModal()">
                        <svg class="fill-current text-black" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 18 18"><path d="M14.53 4.53l-1.06-1.06L9 7.94 4.53 3.47 3.47 4.53 7.94 9l-4.47 4.47 1.06 1.06L9 10.06l4.47 4.47 1.06-1.06L10.06 9z"></path></svg>
                    </div>
                </div>
                <form id="class-form">
                    <input type="hidden" id="edit-class-id">
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Class Name</label>
                        <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="class-name" type="text" placeholder="e.g. Calculus I" required>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Categories & Weights (%)</label>
                        <div id="category-inputs" class="space-y-2">
                            <!-- Categories injected here -->
                        </div>
                        <button type="button" onclick="addCategoryInput()" class="text-blue-500 text-sm mt-2 hover:underline font-bold">+ Add Category</button>
                    </div>

                    <div class="flex justify-end pt-2">
                        <button type="button" onclick="deleteClass()" id="delete-class-btn" class="hidden text-red-500 mr-auto hover:text-red-700 font-bold border border-red-200 px-3 py-1 rounded">Delete Class</button>
                        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Save Class</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- ADD ASSIGNMENT MODAL -->
    <div id="assignment-modal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50"></div>
        <div class="modal-container bg-white w-11/12 md:max-w-md mx-auto rounded-lg shadow-lg z-50 overflow-y-auto max-h-[90vh]">
            <div class="modal-content py-4 text-left px-6">
                <div class="flex justify-between items-center pb-3">
                    <p class="text-2xl font-bold">Assignment</p>
                    <div class="modal-close cursor-pointer z-50 p-2" onclick="closeAssignmentModal()">
                        <svg class="fill-current text-black" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 18 18"><path d="M14.53 4.53l-1.06-1.06L9 7.94 4.53 3.47 3.47 4.53 7.94 9l-4.47 4.47 1.06 1.06L9 10.06l4.47 4.47 1.06-1.06L10.06 9z"></path></svg>
                    </div>
                </div>
                <form id="assignment-form">
                    <input type="hidden" id="asg-class-id">
                    <input type="hidden" id="asg-id">
                    
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Name</label>
                        <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" id="asg-name" type="text" required>
                    </div>

                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Category</label>
                        <select id="asg-category" class="shadow border rounded w-full py-2 px-3 text-gray-700 bg-white" required>
                            <!-- Options filled via JS -->
                        </select>
                    </div>

                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Due Date (Optional)</label>
                        <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" id="asg-date" type="date">
                    </div>

                    <div class="flex gap-4 mb-4">
                        <div class="w-1/2">
                            <label class="block text-gray-700 text-sm font-bold mb-2">Score</label>
                            <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" id="asg-score" type="number" step="0.1" placeholder="--" >
                        </div>
                        <div class="w-1/2">
                            <label class="block text-gray-700 text-sm font-bold mb-2">Total</label>
                            <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" id="asg-total" type="number" value="100" step="0.1">
                        </div>
                    </div>

                    <div class="flex justify-end pt-2">
                        <button type="button" id="delete-asg-btn" class="hidden text-red-500 mr-auto hover:text-red-700 font-bold border border-red-200 px-3 py-1 rounded" onclick="deleteAssignment()">Delete</button>
                        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Save</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- SHARE LINK MODAL -->
    <div id="share-modal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50"></div>
        <div class="modal-container bg-white w-11/12 md:max-w-md mx-auto rounded-lg shadow-lg z-50">
            <div class="modal-content py-4 text-left px-6">
                <p class="text-xl font-bold mb-2">Share Results</p>
                <p class="text-sm text-gray-600 mb-4">Anyone with this link can view your grades (read-only).</p>
                
                <div class="flex items-center gap-2">
                    <input type="text" id="share-url-input" class="bg-gray-100 border rounded w-full py-2 px-3 text-gray-600" readonly>
                    <button onclick="copyShareLink()" class="bg-blue-600 text-white px-3 py-2 rounded hover:bg-blue-700">Copy</button>
                </div>
                
                <div class="mt-4 text-right">
                    <button class="text-gray-500 hover:text-gray-700" onclick="toggleModal('share-modal')">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- SUPABASE CONFIGURATION ---
        const SUPABASE_URL = 'https://njgjgpiamweujgyknqtz.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_3bRvo_Zuppdi4ICnOtfjeA_VWfp6Zyx'; 
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- STATE MANAGEMENT ---
        let state = {
            classes: [], 
            activeTab: null,
            user: null,
            isReadOnly: false, // For shared view
            shareId: null
        };

        // --- INITIALIZATION ---
        
        async function init() {
            // Check if URL has ?share=ID
            const urlParams = new URLSearchParams(window.location.search);
            const shareParam = urlParams.get('share');

            if (shareParam) {
                // READ ONLY MODE
                state.isReadOnly = true;
                loadSharedData(shareParam);
            } else {
                // NORMAL MODE
                checkUser();
            }
        }

        // --- AUTHENTICATION ---
        async function checkUser() {
            const { data: { user } } = await supabaseClient.auth.getUser();
            state.user = user;
            updateAuthUI();
            if (user) {
                loadDataFromSupabase();
            } else {
                loadLocalData(); 
            }
        }

        function updateAuthUI() {
            const loginBtn = document.getElementById('login-btn');
            const userInfo = document.getElementById('user-info');
            const userEmail = document.getElementById('user-email');
            const addClassBtn = document.getElementById('add-class-btn');

            if (state.isReadOnly) {
                // Hide auth stuff in read only mode
                loginBtn.classList.add('hidden');
                userInfo.classList.add('hidden');
                addClassBtn.classList.add('hidden');
                document.getElementById('public-banner').classList.remove('hidden');
                return;
            }

            if (state.user) {
                loginBtn.classList.add('hidden');
                userInfo.classList.remove('hidden');
                userEmail.innerText = state.user.email;
            } else {
                loginBtn.classList.remove('hidden');
                userInfo.classList.add('hidden');
            }
        }

        document.getElementById('login-btn').addEventListener('click', async () => {
            await supabaseClient.auth.signInWithOAuth({
                provider: 'google',
                options: {
                    redirectTo: window.location.href // Redirect back to current page
                }
            });
        });

        document.getElementById('logout-btn').addEventListener('click', async () => {
            await supabaseClient.auth.signOut();
            state.user = null;
            state.classes = [];
            state.activeTab = null;
            state.shareId = null;
            updateAuthUI();
            render();
            document.getElementById('class-tabs').innerHTML = '';
            document.getElementById('class-content').innerHTML = '<div class="text-center text-gray-400 mt-20"><p>Please login to see your data.</p></div>';
            document.getElementById('overall-gpa').innerText = '0.00';
            document.getElementById('todo-list').innerHTML = '';
        });

        // --- DATA PERSISTENCE ---

        async function saveData() {
            if(state.isReadOnly) return; // Prevent saving in read-only

            localStorage.setItem('edutrack_data', JSON.stringify(state.classes));
            
            if (state.user) {
                document.getElementById('sync-status').innerText = 'Syncing...';
                
                // Get existing row to preserve share_id if it exists
                const { data: existingData } = await supabaseClient
                    .from('user_data')
                    .select('id, share_id')
                    .eq('user_id', state.user.id)
                    .single();

                const updatePayload = { data: state.classes, updated_at: new Date() };
                
                if (existingData) {
                    state.shareId = existingData.share_id;
                    await supabaseClient
                        .from('user_data')
                        .update(updatePayload)
                        .eq('user_id', state.user.id);
                } else {
                    await supabaseClient
                        .from('user_data')
                        .insert([{ user_id: state.user.id, data: state.classes }]);
                }
                
                setTimeout(() => {
                    document.getElementById('sync-status').innerText = 'Synced';
                }, 1000);
            }
        }

        function loadLocalData() {
            const stored = localStorage.getItem('edutrack_data');
            if (stored) {
                state.classes = JSON.parse(stored);
                if(state.classes.length > 0 && !state.activeTab) state.activeTab = state.classes[0].id;
                render();
            }
        }

        async function loadDataFromSupabase() {
            document.getElementById('sync-status').innerText = 'Loading...';
            const { data, error } = await supabaseClient
                .from('user_data')
                .select('data, share_id')
                .eq('user_id', state.user.id)
                .single();

            if (data) {
                if (data.data) state.classes = data.data;
                state.shareId = data.share_id;
                if(state.classes.length > 0) state.activeTab = state.classes[0].id;
                localStorage.setItem('edutrack_data', JSON.stringify(state.classes));
                render();
            } else {
                loadLocalData();
            }
            document.getElementById('sync-status').innerText = 'Synced';
        }

        async function loadSharedData(shareId) {
            updateAuthUI(); // Show public banner
            
            // Fetch using the Share ID via the public policy
            const { data, error } = await supabaseClient
                .from('user_data')
                .select('data')
                .eq('share_id', shareId)
                .single();

            if (data && data.data) {
                state.classes = data.data;
                if(state.classes.length > 0) state.activeTab = state.classes[0].id;
                render();
            } else {
                alert("Shared link is invalid or data not found.");
            }
        }

        // --- SHARING LOGIC ---

        async function generateShareLink() {
            if (!state.user) return alert("Please login to share.");

            let currentShareId = state.shareId;

            // If no share ID exists, generate one and save it
            if (!currentShareId) {
                currentShareId = Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
                state.shareId = currentShareId;
                
                await supabaseClient
                    .from('user_data')
                    .update({ share_id: currentShareId })
                    .eq('user_id', state.user.id);
            }

            // Construct URL
            const url = `${window.location.origin}${window.location.pathname}?share=${currentShareId}`;
            
            document.getElementById('share-url-input').value = url;
            toggleModal('share-modal');
        }

        function copyShareLink() {
            const copyText = document.getElementById("share-url-input");
            copyText.select();
            document.execCommand("copy"); // Fallback for older browsers
            // Or use navigator.clipboard.writeText(copyText.value);
            alert("Link copied to clipboard!");
        }

        // --- CORE LOGIC (GPA & GRADES) ---

        function calculateClassGrade(cls) {
            let totalWeightUsed = 0;
            let weightedSum = 0;

            cls.categories.forEach(cat => {
                const assignments = cls.assignments.filter(a => a.categoryId === cat.id && a.score !== null && a.score !== "");
                
                if (assignments.length > 0) {
                    let catTotalPoints = 0;
                    let catEarnedPoints = 0;

                    assignments.forEach(a => {
                        catEarnedPoints += parseFloat(a.score);
                        catTotalPoints += parseFloat(a.total);
                    });

                    if (catTotalPoints > 0) {
                        const catPercentage = (catEarnedPoints / catTotalPoints);
                        weightedSum += catPercentage * parseFloat(cat.weight);
                        totalWeightUsed += parseFloat(cat.weight);
                    }
                }
            });

            if (totalWeightUsed === 0) return null; 

            return (weightedSum / totalWeightUsed) * 100;
        }

        function getLetterGrade(percentage) {
            if (percentage === null) return 'N/A';
            if (percentage >= 90) return 'A';
            if (percentage >= 80) return 'B';
            if (percentage >= 70) return 'C';
            if (percentage >= 60) return 'D';
            return 'F';
        }

        function getGPAFromLetter(letter) {
            if (letter === 'A') return 4.0;
            if (letter === 'B') return 3.0;
            if (letter === 'C') return 2.0;
            if (letter === 'D') return 1.0;
            return 0.0;
        }

        function calculateOverallGPA() {
            let totalGPA = 0;
            let count = 0;

            state.classes.forEach(cls => {
                const grade = calculateClassGrade(cls);
                if (grade !== null) {
                    totalGPA += getGPAFromLetter(getLetterGrade(grade));
                    count++;
                }
            });

            const finalGPA = count === 0 ? 0 : (totalGPA / count);
            document.getElementById('overall-gpa').innerText = finalGPA.toFixed(2);
        }

        function renderTodoList() {
            const listEl = document.getElementById('todo-list');
            listEl.innerHTML = '';

            let allAssignments = [];
            state.classes.forEach(cls => {
                cls.assignments.forEach(asg => {
                    // Include if it has no score (not done) AND has a due date, OR if it has a future due date
                    if ((!asg.score || asg.score === "") && asg.dueDate) {
                        allAssignments.push({ ...asg, className: cls.name, classId: cls.id });
                    }
                });
            });

            // Sort by date
            allAssignments.sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));

            if (allAssignments.length === 0) {
                listEl.innerHTML = '<p class="text-gray-400 italic">No upcoming assignments.</p>';
                return;
            }

            const today = new Date();
            today.setHours(0,0,0,0);

            allAssignments.forEach(asg => {
                const dueDate = new Date(asg.dueDate);
                dueDate.setHours(0,0,0,0); // Normalize time
                
                let badgeClass = 'badge-upcoming';
                let timeText = asg.dueDate;

                if (dueDate < today) {
                    badgeClass = 'badge-overdue';
                    timeText += ' (Overdue)';
                } else if (dueDate.getTime() === today.getTime()) {
                    badgeClass = 'bg-yellow-100 text-yellow-800';
                    timeText = 'Today';
                }

                const item = document.createElement('div');
                item.className = 'flex justify-between items-center bg-gray-50 p-2 rounded border border-gray-100';
                item.innerHTML = `
                    <div>
                        <span class="font-medium text-gray-800">${asg.name}</span>
                        <span class="text-xs text-gray-500 block">${asg.className}</span>
                    </div>
                    <span class="text-xs font-semibold px-2 py-1 rounded ${badgeClass}">${timeText}</span>
                `;
                // Add click to edit if not read only
                if (!state.isReadOnly) {
                    item.classList.add('cursor-pointer', 'hover:bg-gray-100');
                    item.onclick = () => {
                        state.activeTab = asg.classId;
                        render(); // Switch tab
                        editAssignment(asg.id); // Open modal
                    };
                }
                listEl.appendChild(item);
            });
        }

        // --- UI RENDERING ---

        function render() {
            renderTodoList();
            
            const tabsContainer = document.getElementById('class-tabs');
            const contentContainer = document.getElementById('class-content');
            
            tabsContainer.innerHTML = '';
            
            if (state.classes.length === 0) {
                contentContainer.innerHTML = '<div class="text-center text-gray-400 mt-20"><p>No classes added yet.</p></div>';
                calculateOverallGPA();
                return;
            }

            state.classes.forEach(cls => {
                const isActive = cls.id === state.activeTab;
                const tabBtn = document.createElement('a');
                tabBtn.className = `cursor-pointer whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm ${isActive ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'}`;
                tabBtn.innerText = cls.name;
                tabBtn.onclick = () => { state.activeTab = cls.id; render(); };
                tabsContainer.appendChild(tabBtn);
            });

            const activeClass = state.classes.find(c => c.id === state.activeTab);
            if (activeClass) {
                const currentGrade = calculateClassGrade(activeClass);
                const letterGrade = getLetterGrade(currentGrade);
                const gradeColorClass = `grade-${letterGrade}`;

                let assignmentsHtml = '';
                
                if(!activeClass.assignments || activeClass.assignments.length === 0) {
                     assignmentsHtml = `<div class="text-center text-gray-400 py-10">No assignments yet.</div>`;
                     if(!activeClass.assignments) activeClass.assignments = [];
                } else {
                    assignmentsHtml = `<div class="bg-white shadow overflow-hidden sm:rounded-md mt-4"><ul class="divide-y divide-gray-200">`;
                    
                    // Sort: Unscored/Upcoming first, then by date
                    activeClass.assignments.sort((a,b) => {
                         if (a.dueDate && b.dueDate) return new Date(b.dueDate) - new Date(a.dueDate);
                         return 0;
                    });

                    activeClass.assignments.forEach(asg => {
                        const cat = activeClass.categories.find(c => c.id === asg.categoryId);
                        const catName = cat ? cat.name : 'Unknown';
                        const scoreDisplay = (asg.score !== null && asg.score !== "") ? `${asg.score}/${asg.total}` : '-';
                        const percent = (asg.score !== null && asg.score !== "") ? Math.round((asg.score/asg.total)*100) : null;
                        
                        let percentColor = 'text-gray-500';
                        if (percent !== null) {
                            percentColor = percent >= 90 ? 'text-green-600' : percent < 60 ? 'text-red-500' : 'text-gray-500';
                        }

                        // Determine functionality based on Read Only
                        const clickAction = state.isReadOnly ? '' : `onclick="editAssignment('${asg.id}')"`;
                        const cursorClass = state.isReadOnly ? '' : 'cursor-pointer hover:bg-gray-50 group';
                        const editLabel = state.isReadOnly ? '' : '<span class="text-gray-300 text-sm group-hover:text-gray-500">Edit</span>';

                        const dateBadge = asg.dueDate ? `<span class="ml-2 text-xs text-gray-400 border border-gray-200 rounded px-1">${asg.dueDate}</span>` : '';

                        assignmentsHtml += `
                            <li class="px-4 py-4 sm:px-6 flex justify-between items-center ${cursorClass}" ${clickAction}>
                                <div>
                                    <div class="flex items-center">
                                        <p class="text-sm font-medium text-blue-600 truncate">${asg.name}</p>
                                        ${dateBadge}
                                    </div>
                                    <p class="text-xs text-gray-500">${catName}</p>
                                </div>
                                <div class="flex items-center gap-4">
                                    <div class="text-right">
                                        <p class="text-sm font-bold text-gray-900">${scoreDisplay}</p>
                                        <p class="text-xs ${percentColor}">${percent !== null ? percent + '%' : 'Pending'}</p>
                                    </div>
                                    ${editLabel}
                                </div>
                            </li>
                        `;
                    });
                    assignmentsHtml += `</ul></div>`;
                }

                // Header buttons (Edit Class, Add Assignment)
                const editClassBtn = state.isReadOnly ? '' : `<button onclick="openClassModal('${activeClass.id}')" class="absolute top-4 right-4 text-gray-400 hover:text-blue-600 border border-gray-200 rounded px-2 text-xs font-semibold uppercase">Edit Class</button>`;
                
                const addAsgBtn = state.isReadOnly ? '' : `<button onclick="openAssignmentModal()" class="bg-blue-600 text-white text-sm px-3 py-1.5 rounded hover:bg-blue-700 shadow-sm">+ Add Assignment</button>`;

                contentContainer.innerHTML = `
                    <div class="flex flex-col md:flex-row gap-6">
                        <div class="md:w-1/3 space-y-4">
                            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 relative">
                                ${editClassBtn}
                                <h3 class="text-gray-500 text-xs uppercase tracking-wide">Current Grade</h3>
                                <div class="flex items-baseline mt-2">
                                    <span class="text-5xl font-extrabold ${gradeColorClass}">${currentGrade ? currentGrade.toFixed(2) : '--'}%</span>
                                    <span class="ml-2 text-2xl font-medium text-gray-400">${letterGrade}</span>
                                </div>
                                <div class="mt-4 pt-4 border-t border-gray-100">
                                    <h4 class="text-xs font-semibold text-gray-400 mb-2">Category Breakdown</h4>
                                    <div class="space-y-2">
                                        ${activeClass.categories.map(cat => {
                                            const catAsgs = activeClass.assignments.filter(a => a.categoryId === cat.id && a.score);
                                            let earned = 0, total = 0;
                                            catAsgs.forEach(a => { earned += parseFloat(a.score); total += parseFloat(a.total); });
                                            const avg = total > 0 ? Math.round((earned/total)*100) : 0;
                                            return `
                                                <div class="flex justify-between text-sm">
                                                    <span class="text-gray-600">${cat.name} <span class="text-xs text-gray-400">(${cat.weight}%)</span></span>
                                                    <span class="font-bold ${total > 0 ? '' : 'text-gray-300'}">${total > 0 ? avg + '%' : '--'}</span>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="md:w-2/3">
                            <div class="flex justify-between items-center mb-2">
                                <h3 class="text-lg font-bold text-gray-800">Assignments</h3>
                                ${addAsgBtn}
                            </div>
                            ${assignmentsHtml}
                        </div>
                    </div>
                `;
            }
            calculateOverallGPA();
        }

        // --- MODAL & FORM HANDLERS ---

        function toggleModal(modalID) {
            const modal = document.getElementById(modalID);
            modal.classList.toggle('opacity-0');
            modal.classList.toggle('pointer-events-none');
            document.body.classList.toggle('modal-active');
        }

        function openClassModal(classId = null) {
            if (state.isReadOnly) return;
            const form = document.getElementById('class-form');
            const deleteBtn = document.getElementById('delete-class-btn');
            const catInputs = document.getElementById('category-inputs');
            catInputs.innerHTML = ''; 

            if (classId) {
                const cls = state.classes.find(c => c.id === classId);
                document.getElementById('edit-class-id').value = cls.id;
                document.getElementById('class-name').value = cls.name;
                cls.categories.forEach(cat => addCategoryInput(cat.name, cat.weight, cat.id));
                deleteBtn.classList.remove('hidden');
            } else {
                document.getElementById('edit-class-id').value = '';
                document.getElementById('class-name').value = '';
                form.reset();
                addCategoryInput('Assignments', 100);
                deleteBtn.classList.add('hidden');
            }
            toggleModal('class-modal');
        }

        function closeClassModal() { toggleModal('class-modal'); }

        function addCategoryInput(name = '', weight = '', id = null) {
            const wrapper = document.createElement('div');
            wrapper.className = 'flex gap-2 category-row items-center';
            const idVal = id ? id : 'new_' + Date.now() + Math.random();
            wrapper.innerHTML = `
                <input type="text" placeholder="Category Name" class="cat-name flex-grow shadow appearance-none border rounded py-2 px-3 text-gray-700" value="${name}" required>
                <input type="number" placeholder="%" class="cat-weight w-20 shadow appearance-none border rounded py-2 px-3 text-gray-700" value="${weight}" required>
                <input type="hidden" class="cat-id" value="${idVal}">
                <button type="button" onclick="this.closest('.category-row').remove()" class="text-red-500 hover:text-red-700 px-2 font-bold text-xl leading-none">&times;</button>
            `;
            document.getElementById('category-inputs').appendChild(wrapper);
        }

        document.getElementById('class-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const id = document.getElementById('edit-class-id').value;
            const name = document.getElementById('class-name').value;
            
            const categories = [];
            document.querySelectorAll('.category-row').forEach(row => {
                categories.push({
                    id: row.querySelector('.cat-id').value,
                    name: row.querySelector('.cat-name').value,
                    weight: row.querySelector('.cat-weight').value
                });
            });

            if (categories.length === 0) {
                alert("Please add at least one category.");
                return;
            }

            if (id) {
                const cls = state.classes.find(c => c.id === id);
                cls.name = name;
                cls.categories = categories;
            } else {
                const newClass = {
                    id: 'cls_' + Date.now(),
                    name: name,
                    categories: categories,
                    assignments: []
                };
                state.classes.push(newClass);
                state.activeTab = newClass.id;
            }
            
            saveData();
            render();
            closeClassModal();
        });

        function deleteClass() {
            if(confirm('Are you sure? This will delete all assignments for this class.')) {
                const id = document.getElementById('edit-class-id').value;
                state.classes = state.classes.filter(c => c.id !== id);
                state.activeTab = state.classes.length > 0 ? state.classes[0].id : null;
                saveData();
                render();
                closeClassModal();
            }
        }

        function openAssignmentModal() {
            if (state.isReadOnly) return;
            if (!state.activeTab) return alert("Select a class first");
            
            const activeClass = state.classes.find(c => c.id === state.activeTab);
            const select = document.getElementById('asg-category');
            select.innerHTML = '';
            
            if (activeClass.categories.length === 0) {
                alert("This class has no categories. Please edit the class to add categories.");
                return;
            }

            activeClass.categories.forEach(cat => {
                const opt = document.createElement('option');
                opt.value = cat.id;
                opt.innerText = `${cat.name} (${cat.weight}%)`;
                select.appendChild(opt);
            });

            document.getElementById('asg-class-id').value = activeClass.id;
            document.getElementById('asg-id').value = ''; 
            document.getElementById('delete-asg-btn').classList.add('hidden');
            document.getElementById('assignment-form').reset();
            
            toggleModal('assignment-modal');
        }

        function editAssignment(asgId) {
            if (state.isReadOnly) return;
            const activeClass = state.classes.find(c => c.id === state.activeTab);
            const asg = activeClass.assignments.find(a => a.id === asgId);
            
            openAssignmentModal(); 
            
            document.getElementById('asg-id').value = asg.id;
            document.getElementById('asg-name').value = asg.name;
            document.getElementById('asg-category').value = asg.categoryId;
            document.getElementById('asg-score').value = asg.score;
            document.getElementById('asg-total').value = asg.total;
            document.getElementById('asg-date').value = asg.dueDate || '';
            document.getElementById('delete-asg-btn').classList.remove('hidden');
        }
        
        function deleteAssignment() {
            if(confirm('Are you sure you want to delete this assignment?')) {
                const classId = document.getElementById('asg-class-id').value;
                const asgId = document.getElementById('asg-id').value;
                const cls = state.classes.find(c => c.id === classId);
                
                cls.assignments = cls.assignments.filter(a => a.id !== asgId);
                saveData();
                render();
                closeAssignmentModal();
            }
        }

        function closeAssignmentModal() { toggleModal('assignment-modal'); }

        document.getElementById('assignment-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const classId = document.getElementById('asg-class-id').value;
            const asgId = document.getElementById('asg-id').value;
            const name = document.getElementById('asg-name').value;
            const catId = document.getElementById('asg-category').value;
            const score = document.getElementById('asg-score').value;
            const total = document.getElementById('asg-total').value;
            const date = document.getElementById('asg-date').value;

            const cls = state.classes.find(c => c.id === classId);
            
            if (asgId) {
                const asg = cls.assignments.find(a => a.id === asgId);
                asg.name = name;
                asg.categoryId = catId;
                asg.score = score;
                asg.total = total;
                asg.dueDate = date;
            } else {
                cls.assignments.push({
                    id: 'asg_' + Date.now(),
                    categoryId: catId,
                    name: name,
                    score: score,
                    total: total,
                    dueDate: date,
                    created_at: new Date().toISOString()
                });
            }

            saveData();
            render();
            closeAssignmentModal();
        });

        // Initialize App
        init();

    </script>
</body>
</html>